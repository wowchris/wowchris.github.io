<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="红曳的Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Knowledge is power">
<meta property="og:type" content="website">
<meta property="og:title" content="红曳的Blog">
<meta property="og:url" content="http://www.jjl1979.com/index.html">
<meta property="og:site_name" content="红曳的Blog">
<meta property="og:description" content="Knowledge is power">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="红曳的Blog">
<meta name="twitter:description" content="Knowledge is power">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.jjl1979.com/"/>








  <title> 红曳的Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">红曳的Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/03/09/nginx基本功能实现/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/09/nginx基本功能实现/" itemprop="url">
                  nginx基本功能实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-09T15:57:23+08:00">
                2017-03-09
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基于用户认证"><a href="#基于用户认证" class="headerlink" title="基于用户认证"></a>基于用户认证</h2><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        auth_basic &quot;www.bjwf125.com&quot;;</div><div class="line">        auth_basic_user_file /www/html/.passwd;</div><div class="line">        &#125;</div><div class="line"> ｝</div></pre></td></tr></table></figure>
<h3 id="创建文档根目录以及使用httpd-tools中的htpasswd工具创建用户"><a href="#创建文档根目录以及使用httpd-tools中的htpasswd工具创建用户" class="headerlink" title="创建文档根目录以及使用httpd-tools中的htpasswd工具创建用户"></a>创建文档根目录以及使用httpd-tools中的htpasswd工具创建用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@mail ~]# mkdir -pv /www/html</div><div class="line">mkdir: created directory `/www&apos;</div><div class="line">mkdir: created directory `/www/html&apos;</div><div class="line">[root@mail ~]# echo &quot;Welcome to bjwf125&quot; &gt; /www/html/index.html</div><div class="line">[root@mail ~]# yum -y install httpd-tools</div><div class="line">[root@mail ~]# htpasswd -c -m /www/html/.passwd centos    #创建centos用户</div><div class="line">New password:                                    #输入密码</div><div class="line">Re-type new password:                            #再次输入</div><div class="line">Adding password for user centos</div><div class="line">（3）、重新载入配置文件</div><div class="line">[root@mail ~]# nginx -t    #检查Nginx语法</div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</div><div class="line">[root@mail ~]# service nginx reload     #重新载入</div></pre></td></tr></table></figure>
<p><img src="http://wowchris.github.io/2017/03/09/nginx基本功能实现/qUniami.png" alt=""></p>
<h2 id="基于IP认证"><a href="#基于IP认证" class="headerlink" title="基于IP认证"></a>基于IP认证</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        deny 192.168.9.0/24;</div><div class="line">        allow all;</div><div class="line">        &#125;</div><div class="line"> ｝</div></pre></td></tr></table></figure>
<h2 id="基于gzip压缩"><a href="#基于gzip压缩" class="headerlink" title="基于gzip压缩"></a>基于gzip压缩</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"> server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root   /www/html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        gzip on;</div><div class="line">        gzip_http_version 1.0;</div><div class="line">        gzip_min_length 1000;</div><div class="line">        gzip_proxied expired no-cache no-store private auth;</div><div class="line">        gzip_types text/plain application/xml text/css application/x-javascript text/xml</div><div class="line">             application/xml+rss text/javascript application/javascript application/json;</div><div class="line">        gzip_disable msie6 safari;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"> ｝</div><div class="line">[root@mail ~]# nginx -t</div><div class="line">[root@mail ~]# service nginx reload</div><div class="line">[root@mail ~]# cp /etc/rc.d/rc.sysinit /www/html/zip.html</div><div class="line">[root@mail ~]# ll /www/html/zip.html -h</div><div class="line">-rwxr-xr-x 1 root root 20K Jan 13 10:01 /www/html/zip.html</div></pre></td></tr></table></figure>
<p><img src="http://wowchris.github.io/2017/03/09/nginx基本功能实现/JbAJreI.png" alt=""></p>
<h2 id="定制响应头部"><a href="#定制响应头部" class="headerlink" title="定制响应头部"></a>定制响应头部</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root   /www/html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        expires 24h;</div><div class="line">        add_header bjwf125 mymail;</div><div class="line">        &#125;</div><div class="line">｝</div><div class="line">[root@mail ~]# nginx -t</div><div class="line">[root@mail ~]# service nginx reload</div></pre></td></tr></table></figure>
<p><img src="http://wowchris.github.io/2017/03/09/nginx基本功能实现/header.png" alt=""></p>
<h2 id="URL重定向"><a href="#URL重定向" class="headerlink" title="URL重定向"></a>URL重定向</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">语法格式：</div><div class="line">   rewrite grgex replacement [flages]</div><div class="line">   flages</div><div class="line">   last:一旦被当前规则匹配并重写后立即停止检查其他后续的rewrite的规则，而后通过重写后的规则重写发起请求;</div><div class="line">   bleak：一旦被当前规则匹配并重写后立即停止后续的其他rewrite的规则，而后由nginx进行后续操作；</div><div class="line">   redirect：返回302临时重定向</div><div class="line">   permanent：返回301永久重定向</div><div class="line">例如：</div><div class="line">[root@mail ~]# vim /etc/nginx/nginx.conf</div><div class="line"> server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root   /www/html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        rewrite ^/admin/(.*)$ /web/$1;</div><div class="line">        &#125;</div><div class="line">  ｝</div><div class="line">  </div><div class="line">[root@mail ~]# mkdir -pv /www/html/&#123;admin,web&#125;</div><div class="line">[root@mail ~]# echo &quot;mail.bjwf125.com&quot; &gt; /www/html/web/index.html</div><div class="line">[root@mail ~]# nginx -t</div><div class="line">[root@mail ~]# service nginx reload</div></pre></td></tr></table></figure>
<p><img src="http://wowchris.github.io/2017/03/09/nginx基本功能实现/URL.png" alt=""></p>
<h2 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">[root@mail nginx]# vim /etc/nginx/nginx.conf</div><div class="line">#注释掉http&#123;&#125;段中的预定义server&#123;&#125;段中的所有内容；</div><div class="line">在文件末尾｝前一行添加一条：</div><div class="line">include conf.d/nginx-vhost.conf;</div><div class="line">#方便后面定义，根据个人习惯而已，也可以直接在/etc/nginx/nginx.conf中配置</div><div class="line">[root@mail nginx]# vim /etc/nginx/conf.d/nginx-vhost.conf </div><div class="line">server &#123;</div><div class="line">   listen       80;</div><div class="line">   server_name  www.a.com;</div><div class="line">        </div><div class="line">   location / &#123;</div><div class="line">        root    /www/html/a;</div><div class="line">        index   index.html index.htm;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">server &#123;</div><div class="line">   listen       80;</div><div class="line">   server_name  www.b.com;</div><div class="line">        </div><div class="line">   location / &#123;</div><div class="line">        root    /www/html/b;</div><div class="line">        index   index.html index.htm;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">[root@mail nginx]# mkdir /www/html/&#123;a,b&#125; -pv</div><div class="line">mkdir: created directory `/www/html/a&apos;</div><div class="line">mkdir: created directory `/www/html/b&apos;</div><div class="line">[root@mail nginx]# echo &quot;www.a.com&quot; &gt; /www/html/a/index.html</div><div class="line">[root@mail nginx]# echo &quot;www.b.com&quot; &gt; /www/html/b/index.html</div><div class="line">[root@mail nginx]# vim /etc/hosts</div><div class="line">192.168.9.9     www.a.com</div><div class="line">192.168.9.9     www.b.com</div><div class="line">[root@mail nginx]# service nginx reload</div><div class="line">[root@mail nginx]# curl http://www.a.com</div><div class="line">www.a.com</div><div class="line">[root@mail nginx]# curl http://www.b.com</div><div class="line">www.b.com</div><div class="line">###虚拟主机最简单的方式已经配置完成，但是虚拟主机里面还有很多参数。</div><div class="line">7、防盗链</div><div class="line">（1）、定义合规的引用</div><div class="line">        valid_referers none | blocked | server_names | string ...;</div><div class="line"> (2)、拒绝不合规的引用</div><div class="line">         if ($invalid referer) &#123;</div><div class="line">          rewrite ^/ http://www.b.com/403.html;</div><div class="line">         &#125;</div><div class="line">  ##具体示例如下：</div><div class="line">  [root@mail conf.d]# vim nginx-vhost.conf</div><div class="line">   server &#123;</div><div class="line">   listen       80;</div><div class="line">   server_name  www.b.com;</div><div class="line">        </div><div class="line">   location / &#123;</div><div class="line">        root    /www/html/b;</div><div class="line">        index   index.html index.htm;</div><div class="line">        valid_referers none blocked www.b.com *.b.com；</div><div class="line">        if ($invalid_referer) &#123;</div><div class="line">        rewrite ^/ http://www.b.com/403.html;</div><div class="line">        &#125;</div><div class="line">      ｝</div><div class="line">   &#125; </div><div class="line">   </div><div class="line">   [root@mail conf.d]# vim /www/html/a/index.html</div><div class="line">   www.a.com</div><div class="line">   &lt;img src=&quot;http://www.b.com/images/1.jpg&quot;&gt;   #在a.com中引用</div><div class="line">    [root@mail conf.d]# vim /www/html/b/index.html</div><div class="line">   www.b.com</div><div class="line">   &lt;img src=&quot;http://www.b.com/images/1.jpg&quot;&gt;   #b.com自己引用</div></pre></td></tr></table></figure>
<p><img src="http://wowchris.github.io/2017/03/09/nginx基本功能实现/xuni.png" alt=""><br><img src="http://wowchris.github.io/2017/03/09/nginx基本功能实现/xunib.png" alt=""></p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><p>第一种：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /proxy/ &#123;</div><div class="line">     proxy_pass http://127.0.0.1:81/;</div><div class="line">&#125;</div><div class="line">#会被代理到http://127.0.0.1:81/test.html 这个url</div></pre></td></tr></table></figure></p>
<p>第二种：(相对于第一种，最后少一个 /)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /proxy/ &#123;</div><div class="line">     proxy_pass http://127.0.0.1:81;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#会被代理到http://127.0.0.1:81/proxy/test.html 这个url</div></pre></td></tr></table></figure></p>
<p>hello <a href="http://www.jjl1979.com/2017/03/09/nginx基本功能实现/">http://www.jjl1979.com/2017/03/09/nginx基本功能实现/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/03/09/nginx负载均衡/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/09/nginx负载均衡/" itemprop="url">
                  nginx负载均衡
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-09T14:38:17+08:00">
                2017-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>hello <a href="http://www.jjl1979.com/2017/03/09/nginx负载均衡/">http://www.jjl1979.com/2017/03/09/nginx负载均衡/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/03/09/nginx1-8-1稳定版本ngixn-conf-配置文件解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/09/nginx1-8-1稳定版本ngixn-conf-配置文件解析/" itemprop="url">
                  nginx1.8.1稳定版本ngixn.conf 配置文件解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-09T10:58:16+08:00">
                2017-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="nginx-conf"><a href="#nginx-conf" class="headerlink" title="nginx.conf"></a>nginx.conf</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#定义Nginx运行的用户和用户组  </span></div><div class="line">user www www;  </div><div class="line">   </div><div class="line"><span class="comment">#nginx进程数，建议设置为等于CPU总核心数。  </span></div><div class="line">worker_processes 8;  </div><div class="line">   </div><div class="line"><span class="comment">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]  </span></div><div class="line">error_log ar/loginx/error.log info;  </div><div class="line">   </div><div class="line"><span class="comment">#进程文件  </span></div><div class="line">pid ar/runinx.pid;  </div><div class="line">   </div><div class="line"><span class="comment">#一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。  </span></div><div class="line">worker_rlimit_nofile 65535;  </div><div class="line">   </div><div class="line"><span class="comment">#工作模式与连接数上限  </span></div><div class="line">events  </div><div class="line">&#123;  </div><div class="line"><span class="comment">#参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。  </span></div><div class="line">use epoll;  </div><div class="line"><span class="comment">#单个进程最大连接数（最大连接数=连接数*进程数）  </span></div><div class="line">worker_connections 65535;  </div><div class="line">&#125;  </div><div class="line">   </div><div class="line"><span class="comment">#设定http服务器  </span></div><div class="line">http  </div><div class="line">&#123;  </div><div class="line">include mime.types; <span class="comment">#文件扩展名与文件类型映射表  </span></div><div class="line">default_type application/octet-stream; <span class="comment">#默认文件类型  </span></div><div class="line"><span class="comment">#charset utf-8; #默认编码  </span></div><div class="line">server_names_hash_bucket_size 128; <span class="comment">#服务器名字的hash表大小  </span></div><div class="line">client_header_buffer_size 32k; <span class="comment">#上传文件大小限制  </span></div><div class="line">large_client_header_buffers 4 64k; <span class="comment">#设定请求缓  </span></div><div class="line">client_max_body_size 8m; <span class="comment">#设定请求缓  </span></div><div class="line">sendfile on; <span class="comment">#开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。  </span></div><div class="line">autoindex on; <span class="comment">#开启目录列表访问，合适下载服务器，默认关闭。  </span></div><div class="line">tcp_nopush on; <span class="comment">#防止网络阻塞  </span></div><div class="line">tcp_nodelay on; <span class="comment">#防止网络阻塞  </span></div><div class="line">keepalive_timeout 120; <span class="comment">#长连接超时时间，单位是秒  </span></div><div class="line">   </div><div class="line"><span class="comment">#FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。下面参数看字面意思都能理解。  </span></div><div class="line">fastcgi_connect_timeout 300;  </div><div class="line">fastcgi_send_timeout 300;  </div><div class="line">fastcgi_read_timeout 300;  </div><div class="line">fastcgi_buffer_size 64k;  </div><div class="line">fastcgi_buffers 4 64k;  </div><div class="line">fastcgi_busy_buffers_size 128k;  </div><div class="line">fastcgi_temp_file_write_size 128k;  </div><div class="line">   </div><div class="line"><span class="comment">#gzip模块设置  </span></div><div class="line">gzip on; <span class="comment">#开启gzip压缩输出  </span></div><div class="line">gzip_min_length 1k; <span class="comment">#最小压缩文件大小  </span></div><div class="line">gzip_buffers 4 16k; <span class="comment">#压缩缓冲区  </span></div><div class="line">gzip_http_version 1.0; <span class="comment">#压缩版本（默认1.1，前端如果是squid2.5请使用1.0）  </span></div><div class="line">gzip_comp_level 2; <span class="comment">#压缩等级  </span></div><div class="line">gzip_types text/plain application/x-javascript text/css application/xml;  </div><div class="line"><span class="comment">#压缩类型，默认就已经包含textml，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。  </span></div><div class="line">gzip_vary on;  </div><div class="line"><span class="comment">#limit_zone crawler $binary_remote_addr 10m; #开启限制IP连接数的时候需要使用  </span></div><div class="line">   </div><div class="line">upstream blog.ha97.com &#123;  </div><div class="line"><span class="comment">#upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。  </span></div><div class="line">server 192.168.80.121:80 weight=3;  </div><div class="line">server 192.168.80.122:80 weight=2;  </div><div class="line">server 192.168.80.123:80 weight=3;  </div><div class="line">&#125;  </div><div class="line">   </div><div class="line"><span class="comment">#虚拟主机的配置  </span></div><div class="line">server  </div><div class="line">&#123;  </div><div class="line"><span class="comment">#监听端口  </span></div><div class="line">listen 80;  </div><div class="line"><span class="comment">#域名可以有多个，用空格隔开  </span></div><div class="line">server_name www.ha97.com ha97.com;  </div><div class="line">index index.html index.htm index.php;  </div><div class="line">root /data/www/ha97;  </div><div class="line">location ~ .*.(php|php5)?$  </div><div class="line">&#123;  </div><div class="line">fastcgi_pass 127.0.0.1:9000;  </div><div class="line">fastcgi_index index.php;  </div><div class="line">include fastcgi.conf;  </div><div class="line">&#125;  </div><div class="line"><span class="comment">#图片缓存时间设置  </span></div><div class="line">location ~ .*.(gif|jpg|jpeg|png|bmp|swf)$  </div><div class="line">&#123;  </div><div class="line">expires 10d;  </div><div class="line">&#125;  </div><div class="line"><span class="comment">#JS和CSS缓存时间设置  </span></div><div class="line">location ~ .*.(js|css)?$  </div><div class="line">&#123;  </div><div class="line">expires 1h;  </div><div class="line">&#125;  </div><div class="line"><span class="comment">#日志格式设定  </span></div><div class="line">log_format access <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span>  </div><div class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span>  </div><div class="line"><span class="string">'"$http_user_agent" $http_x_forwarded_for'</span>;  </div><div class="line"><span class="comment">#定义本虚拟主机的访问日志  </span></div><div class="line">access_log ar/loginx/ha97access.log access;  </div><div class="line">   </div><div class="line"><span class="comment">#对 "/" 启用反向代理  </span></div><div class="line">location / &#123;  </div><div class="line">proxy_pass http://127.0.0.1:88;  </div><div class="line">proxy_redirect off;  </div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;  </div><div class="line"><span class="comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP  </span></div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;  </div><div class="line"><span class="comment">#以下是一些反向代理的配置，可选。  </span></div><div class="line">proxy_set_header Host <span class="variable">$host</span>;  </div><div class="line">client_max_body_size 10m; <span class="comment">#允许客户端请求的最大单文件字节数  </span></div><div class="line">client_body_buffer_size 128k; <span class="comment">#缓冲区代理缓冲用户端请求的最大字节数，  </span></div><div class="line">proxy_connect_timeout 90; <span class="comment">#nginx跟后端服务器连接超时时间(代理连接超时)  </span></div><div class="line">proxy_send_timeout 90; <span class="comment">#后端服务器数据回传时间(代理发送超时)  </span></div><div class="line">proxy_read_timeout 90; <span class="comment">#连接成功后，后端服务器响应时间(代理接收超时)  </span></div><div class="line">proxy_buffer_size 4k; <span class="comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小  </span></div><div class="line">proxy_buffers 4 32k; <span class="comment">#proxy_buffers缓冲区，网页平均在32k以下的设置  </span></div><div class="line">proxy_busy_buffers_size 64k; <span class="comment">#高负荷下缓冲大小（proxy_buffers*2）  </span></div><div class="line">proxy_temp_file_write_size 64k;  </div><div class="line"><span class="comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传  </span></div><div class="line">&#125;  </div><div class="line">   </div><div class="line"><span class="comment">#设定查看Nginx状态的地址  </span></div><div class="line">location /NginxStatus &#123;  </div><div class="line">stub_status on;  </div><div class="line">access_log on;  </div><div class="line">auth_basic <span class="string">"NginxStatus"</span>;  </div><div class="line">auth_basic_user_file confpasswd;  </div><div class="line"><span class="comment">#htpasswd文件的内容可以用apache提供的htpasswd工具来产生。  </span></div><div class="line">&#125;  </div><div class="line">   </div><div class="line"><span class="comment">#本地动静分离反向代理配置  </span></div><div class="line"><span class="comment">#所有jsp的页面均交由tomcat或resin处理  </span></div><div class="line">location ~ .(jsp|jspx|<span class="keyword">do</span>)?$ &#123;  </div><div class="line">proxy_set_header Host <span class="variable">$host</span>;  </div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;  </div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;  </div><div class="line">proxy_pass http://127.0.0.1:8080;  </div><div class="line">&#125;  </div><div class="line"><span class="comment">#所有静态文件由nginx直接读取不经过tomcat或resin  </span></div><div class="line">location ~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$  </div><div class="line">&#123; expires 15d; &#125;  </div><div class="line">location ~ .*.(js|css)?$  </div><div class="line">&#123; expires 1h; &#125;  </div><div class="line">&#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="配置文件结构"><a href="#配置文件结构" class="headerlink" title="配置文件结构"></a>配置文件结构</h2><p>Nginx的配置文件nginx.conf位于其安装目录的conf目录下。<br>nginx.conf由多个块组成，最外面的块是main，main包含Events和HTTP，HTTP包含upstream和多个Server，Server又包含多个location：<br><img src="http://wowchris.github.io/2017/03/09/nginx1-8-1稳定版本ngixn-conf-配置文件解析/nginxconf.png" alt=""></p>
<p>main（全局设置）、server（主机设置）、upstream（负载均衡服务器设置）和 location（URL匹配特定位置的设置）。<br>main块设置的指令将影响其他所有设置；<br>server块的指令主要用于指定主机和端口；<br>upstream指令主要用于负载均衡，设置一系列的后端服务器；<br>location块用于匹配网页位置。<br>这四者之间的关系式：server继承main，location继承server，upstream既不会继承其他设置也不会被继承。<br>在这四个部分当中，每个部分都包含若干指令，这些指令主要包含Nginx的主模块指令、事件模块指令、HTTP核心模块指令，同时每个部分还可以使用其他HTTP模块指令，例如Http SSL模块、HttpGzip Static模块和Http Addition模块等。</p>
<h3 id="Nginx的全局配置"><a href="#Nginx的全局配置" class="headerlink" title="Nginx的全局配置"></a>Nginx的全局配置</h3><pre><code>user  nobody nobody;  
worker_processes  2;  
error_log  logs/error.log  notice;  
pid        logs/nginx.pid;  
worker_rlimit_nofile 65535;  

events{  
     use epoll;  
     worker_connections      65536;  
}  
</code></pre><p>含义解释如下：  </p>
<ul>
<li>user是个主模块指令，指定Nginx Worker进程运行用户以及用户组，默认由nobody账号运行。</li>
<li>worker_processes是个主模块指令，指定了Nginx要开启的进程数。每个Nginx进程平均耗费10M~12M内存。建议指定和CPU的数量一致即可。</li>
<li>error_log是个主模块指令，用来定义全局错误日志文件。日志输出级别有debug、info、notice、warn、error、crit可供选择，其中，debug输出日志最为最详细，而crit输出日志最少。</li>
<li>pid是个主模块指令，用来指定进程pid的存储文件位置。</li>
<li>worker_rlimit_nofile用于绑定worker进程和CPU， Linux内核2.4以上可用。</li>
</ul>
<p>events事件指令是设定Nginx的工作模式及连接数上限：use是个事件模块指令，用来指定Nginx的工作模式。Nginx支持的工作模式有select、poll、kqueue、epoll、rtsig和/dev/poll。其中select和poll都是标准的工作模式，kqueue和epoll是高效的工作模式，不同的是epoll用在Linux平台上，而kqueue用在BSD系统中。对于Linux系统，epoll工作模式是首选。<br>worker_connections也是个事件模块指令，用于定义Nginx每个进程的最大连接数，默认是1024。最大客户端连接数由worker_processes和worker_connections决定，即Max_client=worker_processes<em>worker_connections。<br>在作为反向代理时，max_clients变为：max_clients = worker_processes </em> worker_connections/4。<br>进程的最大连接数受Linux系统进程的最大打开文件数限制，在执行操作系统命令“ulimit -n 65536”后worker_connections的设置才能生效  </p>
<h3 id="HTTP服务器配置"><a href="#HTTP服务器配置" class="headerlink" title="HTTP服务器配置"></a>HTTP服务器配置</h3><p>Nginx对HTTP服务器相关属性的配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">http&#123;  </div><div class="line">    include      conf/mime.types;  </div><div class="line">    default_type  application/octet-stream;  </div><div class="line">    log_format main &apos;$remote_addr - $remote_user [$time_local] &apos;  </div><div class="line">    &apos;&quot;$request&quot; $status $bytes_sent &apos;  </div><div class="line">    &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &apos;  </div><div class="line">    &apos;&quot;$gzip_ratio&quot;&apos;;  </div><div class="line">    log_format download &apos;$remote_addr - $remote_user [$time_local] &apos;  </div><div class="line">    &apos;&quot;$request&quot; $status $bytes_sent &apos;  </div><div class="line">    &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &apos;  </div><div class="line">    &apos;&quot;$http_range&quot; &quot;$sent_http_content_range&quot;&apos;;  </div><div class="line">    client_max_body_size  20m;  </div><div class="line">    client_header_buffer_size    32K;  </div><div class="line">    large_client_header_buffers  4 32k;  </div><div class="line">    Sendfile  on;  </div><div class="line">    tcp_nopush     on;  </div><div class="line">    tcp_nodelay    on;  </div><div class="line">    keepalive_timeout 60;  </div><div class="line">    client_header_timeout  10;  </div><div class="line">    client_body_timeout    10;  </div><div class="line">    send_timeout          10;</div></pre></td></tr></table></figure></p>
<p>include是个主模块指令，实现对配置文件所包含的文件的设定，可以减少主配置文件的复杂度。类似于Apache中的include方法。</p>
<font color="#006699" size="3">default_type属于HTTP核心模块指令，这里设定默认类型为二进制流，也就是当文件类型未定义时使用这种方式，例如在没有配置PHP环境时，Nginx是不予解析的，此时，用浏览器访问PHP文件就会出现下载窗口。</font>

<h3 id="日志格式的设定"><a href="#日志格式的设定" class="headerlink" title="日志格式的设定"></a>日志格式的设定</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">log_format main &apos;$remote_addr - $remote_user [$time_local] &apos;  </div><div class="line">&apos;&quot;$request&quot; $status $bytes_sent &apos;  </div><div class="line">&apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &apos;  </div><div class="line">&apos;&quot;$gzip_ratio&quot;&apos;;  </div><div class="line">log_format download &apos;$remote_addr - $remote_user [$time_local] &apos;  </div><div class="line">&apos;&quot;$request&quot; $status $bytes_sent &apos;  </div><div class="line">&apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &apos;  </div><div class="line">&apos;&quot;$http_range&quot; &quot;$sent_http_content_range&quot;&apos;;</div></pre></td></tr></table></figure>
<p>log_format是Nginx的HttpLog模块指令，用于指定Nginx日志的输出格式。main为此日志输出格式的名称，可以在下面的access_log指令中引用。</p>
<ul>
<li>client_max_body_size用来设置允许客户端请求的最大的单个文件字节数；</li>
<li>client_header_buffer_size用于指定来自客户端请求头的headerbuffer大小。对于大多数请求，1K的缓冲区大小已经足够，如果自定义了消息头或有更大的Cookie，可以增加缓冲区大小。这里设置为32K；</li>
<li>large_client_header_buffers用来指定客户端请求中较大的消息头的缓存最大数量和大小， “4”为个数，“128K”为大小，最大缓存量为4个128K；</li>
<li>sendfile参数用于开启高效文件传输模式。将tcp_nopush和tcp_nodelay两个指令设置为on用于防止网络阻塞；</li>
<li>keepalive_timeout设置客户端连接保持活动的超时时间。在超过这个时间之后，服务器会关闭该连接；</li>
<li>client_header_timeout设置客户端请求头读取超时时间。如果超过这个时间，客户端还没有发送任何数据，Nginx将返回“Request time out（408）”错误；</li>
<li>client_body_timeout设置客户端请求主体读取超时时间。如果超过这个时间，客户端还没有发送任何数据，Nginx将返回“Request time out（408）”错误，默认值是60；</li>
<li>send_timeout指定响应客户端的超时时间。这个超时仅限于两个连接活动之间的时间，如果超过这个时间，客户端没有任何活动，Nginx将会关闭连接.</li>
</ul>
<h3 id="HttpGzip模块配置"><a href="#HttpGzip模块配置" class="headerlink" title="HttpGzip模块配置"></a>HttpGzip模块配置</h3><p>下面配置Nginx的HttpGzip模块。这个模块支持在线实时压缩输出数据流。<br>看是否安装了HttpGzip模块：  </p>
<table><tr><td bgcolor="#EDEFF0">[root@vps ~]# /opt/nginx/sbin/nginx  -V<br>configure arguments: –with-http_stub_status_module –with-http_gzip_static_module –prefix=/opt/nginx<br></td></tr></table>

<p>属性设置：<br>    gzip  on;<br>    gzip_min_length  1k;<br>    gzip_buffers     4  16k;<br>    gzip_http_version  1.1;<br>    gzip_comp_level  2;<br>    gzip_types  text/plain application/x-javascript text/css application/xml;<br>    gzip_vary  on;  </p>
<ul>
<li><p>gzip用于设置开启或者关闭gzip模块，“gzip on”表示开启GZIP压缩，实时压缩输出数据流；  </p>
</li>
<li><p>gzip_min_length设置允许压缩的页面最小字节数，页面字节数从header头的Content-Length中获取。默认值是0，不管页面多大都进行压缩。建议设置成大于1K的字节数，小于1K可能会越压越大；  </p>
</li>
<li><p>gzip_buffers表示申请4个单位为16K的内存作为压缩结果流缓存，默认值是申请与原始数据大小相同的内存空间来存储gzip压缩结果；  </p>
</li>
<li><p>gzip_http_version用于设置识别HTTP协议版本，默认是1.1，目前大部分浏览器已经支持GZIP解压，使用默认即可；  </p>
</li>
<li><p>gzip_comp_level用来指定GZIP压缩比，1 压缩比最小，处理速度最快；9 压缩比最大，传输速度快，但处理最慢，也比较消耗cpu资源；  </p>
</li>
<li><p>gzip_types用来指定压缩的类型，无论是否指定，“text/html”类型总是会被压缩的；  </p>
</li>
<li><p>gzip_vary选项可以让前端的缓存服务器缓存经过GZIP压缩的页面，例如用Squid缓存经过Nginx压缩的数据。  </p>
</li>
</ul>
<p>hello <a href="http://www.jjl1979.com/2017/03/09/nginx1-8-1稳定版本ngixn-conf-配置文件解析/">http://www.jjl1979.com/2017/03/09/nginx1-8-1稳定版本ngixn-conf-配置文件解析/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/03/07/redis安装以及php扩展/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/07/redis安装以及php扩展/" itemprop="url">
                  redis安装以及php扩展
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-07T17:12:36+08:00">
                2017-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/PHP/memcache/" itemprop="url" rel="index">
                    <span itemprop="name">memcache</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="memcache-and-redis"><a href="#memcache-and-redis" class="headerlink" title="memcache and redis"></a>memcache and redis</h2><p>[memecache 特点]<br>1:速度最快(没有自测，但网上有详细的测试用例)<br>2:支持水平扩展，可以任意添加节点  </p>
<p>[redis 特点]<br>1:速度没有memcache快<br>2:支持M/S的主从备份<br>3:可以支持多数据库<br>4:操作指令很丰富<br>4:支持异步数据持久化(以文件保存)  </p>
<p>总结:<br>1：如果是简单的数据缓存建议使用MEMCACHE。<br>2：如果要对单一操作的数据量非常的大则使用MEMCACHE<br>3: 如果想做性能很好的缓存集群可以用Redis(M/S读写分离,如weibo中的排行榜等)<br>4: 如果在高并发下又想保存数据则可以用Redis   </p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>cd /usr/local/src/<br>wget <a href="http://download.redis.io/releases/redis-3.2.8.tar.gz" target="_blank" rel="external">http://download.redis.io/releases/redis-3.2.8.tar.gz</a><br>tar -zxvf redis-3.2.8.tar.gz<br>cd redis-3.2.8<br>make  </p>
<p>mkdir -p /usr/local/redis/conf<br>mkdir -p /usr/local/redis/run<br>mkdir -p /usr/local/redis/db<br>cp redis.conf /usr/local/redis/conf/  </p>
<p>cd src  </p>
<h2 id="将src目录下所有可执行文件复制到安装目录"><a href="#将src目录下所有可执行文件复制到安装目录" class="headerlink" title="将src目录下所有可执行文件复制到安装目录"></a>将src目录下所有可执行文件复制到安装目录</h2><p>cp redis-benchmark redis-check-aof redis-check-dump redis-cli redis-server mkreleasehdr.sh /usr/local/redis/  </p>
<h2 id="修改配置文件中的如下选项"><a href="#修改配置文件中的如下选项" class="headerlink" title="修改配置文件中的如下选项"></a>修改配置文件中的如下选项</h2><p>——- vi /usr/local/webserver/redis/conf/redis.conf ——–<br>daemonize yes<br>pidfile /usr/local/redis/run/redis.pid</p>
<h2 id="dir-usr-local-redis-db"><a href="#dir-usr-local-redis-db" class="headerlink" title="dir /usr/local/redis/db"></a>dir /usr/local/redis/db</h2><h2 id="服务脚本"><a href="#服务脚本" class="headerlink" title="服务脚本"></a>服务脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">------- vi /usr/local/redis/start.sh ---------</div><div class="line">#!/bin/bash</div><div class="line">/usr/local/webserver/redis/redis-server /usr/local/webserver/redis/conf/redis.conf</div><div class="line"></div><div class="line"> </div><div class="line">------- vi /usr/local/redis/stop.sh ---------</div><div class="line">#!/bin/bash</div><div class="line">kill `cat /usr/local/redis/run/redis.pid`</div><div class="line">--------------------------------------------------------</div></pre></td></tr></table></figure>
<p>chmod a+x /usr/local/redis/start.sh /usr/local/redis/stop.sh</p>
<h2 id="服务与验证"><a href="#服务与验证" class="headerlink" title="服务与验证"></a>服务与验证</h2><p>/usr/local/webserver/redis/start.sh<br>服务查证:<br>netstat -nlpt | grep 6379  </p>
<p>客户端验证<br>/usr/local/webserver/redis/redis-cli</p>
<blockquote>
<p>set key1 val1<br>get key1</p>
</blockquote>
<h2 id="主从集群配置"><a href="#主从集群配置" class="headerlink" title="主从集群配置"></a>主从集群配置</h2><p>hello <a href="http://www.jjl1979.com/2017/03/07/redis安装以及php扩展/">http://www.jjl1979.com/2017/03/07/redis安装以及php扩展/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/02/21/Tomcat-redis-nginx的session共享/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/21/Tomcat-redis-nginx的session共享/" itemprop="url">
                  Tomcat+redis+nginx的session共享
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-21T19:17:35+08:00">
                2017-02-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tomcat/" itemprop="url" rel="index">
                    <span itemprop="name">tomcat</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tomcat/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tomcat/redis/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>&emsp;使用Nginx+Tomcat实现负载均衡的时候，由于Nginx对不同的请求分发到某一个Tomcat，如果某一个tomcat无法工作或是重新加载就会对用户产生影响，尤其对金融领域会出现session不同步或者丢失的问题，应用nginx_sticky模式分配请求到节点，不管是线上更新还是宕机，用户被分配到其他实例，因为回话是保存在redis中，所以不会影响用户的正常使用。</p>
<p>应用架构<br><img src="http://" alt=""></p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>tomcat7.0<br>nginx1.8.1稳定版<br>JDK1.7.0<br>redis3.2  </p>
<p>安装过程这里不赘述</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>Tomcat</p>
<blockquote>
<p>localhost:8081<br>localhost:8082<br>localhost:8083  </p>
</blockquote>
<p>修改tomcat文件夹中conf/context.xml文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;Valve className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot; /&gt;  </div><div class="line">&lt;Manager className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot;  </div><div class="line">         host=&quot;localhost&quot;  </div><div class="line">         port=&quot;6379&quot;  </div><div class="line">         database=&quot;0&quot;  </div><div class="line">         maxInactiveInterval=&quot;60&quot; /&gt;</div></pre></td></tr></table></figure></p>
<p>nginx.conf配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#user  nobody;</span></div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">error_log  logs/error.log;</div><div class="line"></div><div class="line">pid        logs/nginx.pid;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">	worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#################添加内容###################</span></div><div class="line">http &#123;</div><div class="line"></div><div class="line">		upstream  localhost   &#123;  </div><div class="line">          server   localhost:8081 weight=1;  </div><div class="line">          server   localhost:8082 weight=2;  </div><div class="line">          server   localhost:8083 weight=3; </div><div class="line">	&#125;  </div><div class="line"></div><div class="line">	include       mime.types;</div><div class="line">	default_type  application/octet-stream;</div><div class="line"><span class="comment">###########################################</span></div><div class="line">	log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] 	"$request" '</span></div><div class="line">                  <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                  <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line"></div><div class="line">	access_log  logs/access.log  main;</div><div class="line"></div><div class="line">	sendfile        on;</div><div class="line">	<span class="comment">#tcp_nopush     on;</span></div><div class="line"></div><div class="line">	<span class="comment">#keepalive_timeout  0;</span></div><div class="line">	keepalive_timeout  65;</div><div class="line"></div><div class="line">	<span class="comment">#gzip  on;</span></div><div class="line"></div><div class="line"></div><div class="line">	server &#123;</div><div class="line">    	listen       80;</div><div class="line">    	server_name  localhost;</div><div class="line"></div><div class="line">    	<span class="comment">#charset koi8-r;</span></div><div class="line"></div><div class="line">    	<span class="comment">#access_log  logs/host.access.log  main;</span></div><div class="line"><span class="comment">#################添加内容#######################</span></div><div class="line">    	location / &#123;</div><div class="line">			proxy_pass        http://localhost;  </div><div class="line"><span class="comment">###############################################</span></div><div class="line">        	root   html;</div><div class="line">        	index  index.html index.htm;</div><div class="line">       	 	proxy_set_header  X-Real-IP  <span class="variable">$remote_addr</span>;  </div><div class="line">        	client_max_body_size  100m;  </div><div class="line">    	&#125;</div><div class="line"></div><div class="line">    	<span class="comment">#error_page  404              /404.html;</span></div><div class="line"></div><div class="line">    	<span class="comment"># redirect server error pages to the static page /50x.html</span></div><div class="line">    	<span class="comment">#</span></div><div class="line">    	error_page   500 502 503 504  /50x.html;</div><div class="line">    	location = /50x.html &#123;</div><div class="line">        	root   html;</div><div class="line">    	&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="项目重建"><a href="#项目重建" class="headerlink" title="项目重建"></a>项目重建</h2><ul>
<li>tomcat-redis-session-manager</li>
<li>commons-pool2-2.0</li>
<li>jedis-2.7.2.jar<br>tomcat-redis-session-manager地址：<a href="https://github.com/jcoleman/tomcat-redis-session-manager" target="_blank" rel="external">https://github.com/jcoleman/tomcat-redis-session-manager</a></li>
</ul>
<p>hello <a href="http://www.jjl1979.com/2017/02/21/Tomcat-redis-nginx的session共享/">http://www.jjl1979.com/2017/02/21/Tomcat-redis-nginx的session共享/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/02/21/Redis-应用场景/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/21/Redis-应用场景/" itemprop="url">
                  Redis 应用场景
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-21T11:54:47+08:00">
                2017-02-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="MySql-Memcached架构的问题"><a href="#MySql-Memcached架构的问题" class="headerlink" title="MySql+Memcached架构的问题"></a>MySql+Memcached架构的问题</h2><p>实际MySQL是适合进行海量数据存储的，通过Memcached将热点数据加载到cache，加速访问，很多公司都曾经使用过这样的架构，但随着业务数据量的不断增加，和访问量的持续增长，我们遇到了很多问题：</p>
<ol>
<li>MySQL需要不断进行拆库拆表，Memcached也需不断跟着扩容，扩容和维护工作占据大量开发时间。</li>
<li>Memcached与MySQL数据库数据一致性问题。</li>
<li>Memcached数据命中率低或down机，大量访问直接穿透到DB，MySQL无法支撑。</li>
<li>跨机房cache同步问题。  </li>
</ol>
<p>众多NoSQL百花齐放，如何选择    </p>
<p>最近几年，业界不断涌现出很多各种各样的NoSQL产品，那么如何才能正确地使 用好这些产品，最大化地发挥其长处，是我们需要深入研究和思考的问题，实际归根结底最重要的是了解这些产品的定位，并且了解到每款产品的 tradeoffs，在实际应用中做到扬长避短，总体上这些NoSQL主要用于解决以下几种问题：<br>1.少量数据存储，高速读写访问。此类产品通过数据全部in-momery 的方式来保证高速访问，同时提供数据落地的功能，<strong>实际这正是Redis最主要的适用场景</strong>。<br>2.海量数据存储，分布式系统支持，数据一致性保证，方便的集群节点添加/删除。<br>3.这方面最具代表性的是dynamo和bigtable 2篇论文所阐述的思路。前者是一个完全无中心的设计，节点之间通过gossip方式传递集群信息，数据保证最终一致性，后者是一个中心化的方案设计，通过类似一个分布式锁服务来保证强一致性,数据写入先写内存和redo log，然后定期compat归并到磁盘上，将随机写优化为顺序写，提高写入性能。<br>4.Schema，free，auto-sharding等。比如目前常见的一些文档数据库都是支持schema-free的，直接存储json格式数据，并且支持auto-sharding等功能，比如mongodb。<br>面对这些不同类型的NoSQL产品,我们需要根据我们的业务场景选择最合适的产品。</p>
<p>Redis最适合所有数据in-momory的场景，虽然Redis也提供持久化功能，但实际更多的是一个disk-backed的功能，跟传统意义上的持久化有比较大的差别，那么可能大家就会有疑问，似乎Redis更像一个加强版的Memcached，那么何时使用Memcached,何时使用 Redis呢?<br>如果简单地比较Redis与Memcached的区别，大多数都会得到以下观点：  </p>
<font color="#4590a3" size="3px"><br>1. Redis不仅仅支持简单的k/v类型的数据，同时还提供list，set，zset，hash等数据结构的存储。<br>2. Redis支持数据的备份，即master-slave模式的数据备份。<br>3. Redis支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用。<br></font><br>## Redis常用数据类型<br><br>Redis最为常用的数据类型主要有以下：<br><br>String<br><br>Hash<br><br>List<br><br>Set<br><br>Sorted set<br><br>pub/sub<br><br>Transactions<br><br>在具体描述这几种数据类型之前，我们先通过一张图了解下Redis内部内存管理中是如何描述这些不同数据类型的：<br><br><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/redis核心对象.jpg" alt=""><br><br>首先Redis内部使用一个redisObject对象来表示所有的key和value,redisObject最主要的信息如上图所示：<br><br>type代表一个value对象具体是何种数据类型，<br><br>encoding是不同数据类型在redis内部的存储方式，<br><br>比如：type=string代表value存储的是一个普通字符串，那么对应的encoding可以是raw或者是int,如果是int则代表实际 redis内部是按数值型类存储和表示这个字符串的，当然前提是这个字符串本身可以用数值表示，比如:”123” “456”这样的字符串。<br><br>这里需要特殊说明一下vm字段，只有打开了Redis的虚拟内存功能，此字段才会真正的分配内存，该功能默认是关闭状态的，该功能会在后面具体描述。通 过上图我们可以发现Redis使用redisObject来表示所有的key/value数据是比较浪费内存的，当然这些内存管理成本的付出主要也是为了 给Redis不同数据类型提供一个统一的管理接口，实际作者也提供了多种方法帮助我们尽量节省内存使用，我们随后会具体讨论。<br><br><br><br>## 各种数据类型应用和实现方式<br><br>下面我们先来逐一的分析下这7种数据类型的使用和内部实现方式:<br><br>String:<br><br><br>Strings 数据结构是简单的key-value类型，value其实不仅是String，也可以是数字.<br><br>常用命令:  set,get,decr,incr,mget 等。<br><br>应用场景：String是最常用的一种数据类型，普通的key/ value 存储都可以归为此类.即可以完全实现目前 Memcached 的功能，并且效率更高。还可以享受Redis的定时持久化，操作日志及 Replication等功能。除了提供与 Memcached 一样的get、set、incr、decr 等操作外，Redis还提供了下面一些操作：<br><br>获取字符串长度<br><br>往字符串append内容<br><br>设置和获取字符串的某一段内容<br><br>设置及获取字符串的某一位（bit）<br><br>批量设置一系列字符串的内容<br><br>实现方式：String在redis内部存储默认就是一个字符串，被redisObject所引用，当遇到incr,decr等操作时会转成数值型进行计算，此时redisObject的encoding字段为int。<br><br><br><br>Hash<br><br><br>常用命令：hget,hset,hgetall 等。<br><br>应用场景：在Memcached中，我们经常将一些结构化的信息打包成HashMap，在客户端序列化后存储为一个字符串的值，比如用户的昵称、年龄、性别、积分等，这时候在需要修改其中某一项时，通常需要将所有值取出反序列化后，修改某一项的值，再序列化存储回去。这样不仅增大了开销，也不适用于一些可能并发操作的场合（比如两个并发的操作都需要修改积分）。而Redis的Hash结构可以使你像在数据库中Update一个属性一样只修改某一项属性值。<br><br>    我们简单举个实例来描述下Hash的应用场景，比如我们要存储一个用户信息对象数据，包含以下信息：<br><br>用户ID为查找的key，存储的value用户对象包含姓名，年龄，生日等信息，如果用普通的key/value结构来存储，主要有以下2种存储方式：<br><br><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/redis-key.jpg" alt=""><br><br><br><br>第一种方式将用户ID作为查找key,把其他信息封装成一个对象以序列化的方式存储，这种方式的缺点是，增加了序列化/反序列化的开销，并且在需要修改其中一项信息时，需要把整个对象取回，并且修改操作需要对并发进行保护，引入CAS等复杂问题。<br><br><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/key-values.jpg" alt=""><br><br>第二种方法是这个用户信息对象有多少成员就存成多少个key-value对儿，用用户ID+对应属性的名称作为唯一标识来取得对应属性的值，虽然省去了序列化开销和并发问题，但是用户ID为重复存储，如果存在大量这样的数据，内存浪费还是非常可观的。<br><br>那么Redis提供的Hash很好的解决了这个问题，Redis的Hash实际是内部存储的Value为一个HashMap，并提供了直接存取这个Map成员的接口，如下图：<br><br><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/key-hash.jpg" alt=""><br><br>也就是说，Key仍然是用户ID, value是一个Map，这个Map的key是成员的属性名，value是属性值，这样对数据的修改和存取都可以直接通过其内部Map的 Key(Redis里称内部Map的key为field), 也就是通过 key(用户ID) + field(属性标签) 就可以操作对应属性数据了，既不需要重复存储数据，也不会带来序列化和并发修改控制的问题。很好的解决了问题。<br><br>这里同时需要注意，Redis提供了接口(hgetall)可以直接取到全部的属性数据,但是如果内部Map的成员很多，那么涉及到遍历整个内部 Map的操作，由于Redis单线程模型的缘故，这个遍历操作可能会比较耗时，而另其它客户端的请求完全不响应，这点需要格外注意。<br><br>实现方式：<br><br>上面已经说到Redis Hash对应Value内部实际就是一个HashMap，实际这里会有2种不同实现，这个Hash的成员比较少时Redis为了节省内存会采用类似一维数 组的方式来紧凑存储，而不会采用真正的HashMap结构，对应的value redisObject的encoding为zipmap,当成员数量增大时会自动转成真正的HashMap,此时encoding为ht。<br><br>List<br><br><br>常用命令：lpush,rpush,lpop,rpop,lrange等。<br><br>应用场景：<br><br>Redis list的应用场景非常多，也是Redis最重要的数据结构之一，比如twitter的关注列表，粉丝列表等都可以用Redis的list结构来实现。<br><br>Lists 就是链表，相信略有数据结构知识的人都应该能理解其结构。使用Lists结构，我们可以轻松地实现最新消息排行等功能。Lists的另一个应用就是消息队列，<br>可以利用Lists的PUSH操作，将任务存在Lists中，然后工作线程再用POP操作将任务取出进行执行。Redis还提供了操作Lists中某一段的api，你可以直接查询，删除Lists中某一段的元素。<br><br>实现方式：<br><br>Redis list的实现为一个双向链表，即可以支持反向查找和遍历，更方便操作，不过带来了部分额外的内存开销，Redis内部的很多实现，包括发送缓冲队列等也都是用的这个数据结构。<br><br>Set<br><br><br>常用命令：<br><br>sadd,spop,smembers,sunion 等。<br><br>应用场景：<br><br>Redis set对外提供的功能与list类似是一个列表的功能，特殊之处在于set是可以自动排重的，当你需要存储一个列表数据，又不希望出现重复数据时，set 是一个很好的选择，并且set提供了判断某个成员是否在一个set集合内的重要接口，这个也是list所不能提供的。<br><br>Sets 集合的概念就是一堆不重复值的组合。利用Redis提供的Sets数据结构，可以存储一些集合性的数据，比如在微博应用中，可以将一个用户所有的关注人存 在一个集合中，将其所有粉丝存在一个集合。Redis还为集合提供了求交集、并集、差集等操作，可以非常方便的实现如共同关注、共同喜好、二度好友等功 能，对上面的所有集合操作，你还可以使用不同的命令选择将结果返回给客户端还是存集到一个新的集合中。<br><br>实现方式：<br><br>set 的内部实现是一个 value永远为null的HashMap，实际就是通过计算hash的方式来快速排重的，这也是set能提供判断一个成员是否在集合内的原因。<br><br>Sorted Set<br><br><br>常用命令：<br><br>zadd,zrange,zrem,zcard等<br><br>使用场景：<br><br>Redis sorted set的使用场景与set类似，区别是set不是自动有序的，而sorted set可以通过用户额外提供一个优先级(score)的参数来为成员排序，并且是插入有序的，即自动排序。当你需要一个有序的并且不重复的集合列表，那么 可以选择sorted set数据结构，比如twitter 的public timeline可以以发表时间作为score来存储，这样获取时就是自动按时间排好序的。<br><br>另外还可以用Sorted Sets来做带权重的队列，比如普通消息的score为1，重要消息的score为2，然后工作线程可以选择按score的倒序来获取工作任务。让重要的任务优先执行。<br><br>实现方式：<br><br>Redis sorted set的内部使用HashMap和跳跃表(SkipList)来保证数据的存储和有序，HashMap里放的是成员到score的映射，而跳跃表里存放的 是所有的成员，排序依据是HashMap里存的score,使用跳跃表的结构可以获得比较高的查找效率，并且在实现上比较简单。<br><br>Pub/Sub<br><br><br>Pub/Sub 从字面上理解就是发布（Publish）与订阅（Subscribe），在Redis中，你可以设定对某一个key值进行消息发布及消息订阅，当一个 key值上进行了消息发布后，所有订阅它的客户端都会收到相应的消息。这一功能最明显的用法就是用作实时消息系统，比如普通的即时聊天，群聊等功能。<br><br>Transactions<br><br><br>谁说NoSQL都不支持事务，虽然Redis的Transactions提供的并不是严格的ACID的事务（比如一串用EXEC提交执行的命令，在 执行中服务器宕机，那么会有一部分命令执行了，剩下的没执行），但是这个Transactions还是提供了基本的命令打包执行的功能（在服务器不出问题 的情况下，可以保证一连串的命令是顺序在一起执行的，中间有会有其它客户端命令插进来执行）。Redis还提供了一个Watch功能，你可以对一个key 进行Watch，然后再执行Transactions，在这过程中，如果这个Watched的值进行了修改，那么这个Transactions会发现并拒 绝执行。<br><br><br><br>## Redis实际应用场景<br><br>Redis在很多方面与其他数据库解决方案不同：它使用内存提供主存储支持，而仅使用硬盘做持久性的存储；它的数据模型非常独特，用的是单线程。另一个大区别在于，你可以在开发环境中使用Redis的功能，但却不需要转到Redis。<br><br>转向Redis当然也是可取的，许多开发者从一开始就把Redis作为首选数据库；但设想如果你的开发环境已经搭建好， 应用已经在上面运行了，那么更换数据库框架显然不那么容易。另外在一些需要大容量数据集的应用，Redis也并不适合，因为它的数据集不会超过系统可用的 内存。所以如果你有大数据应用，而且主要是读取访问模式，那么Redis并不是正确的选择。<br><br>然而我喜欢Redis的一点就是你可以把它融入到你的系统中来，这就能够解决很多问题，比如那些你现有的数据库处理起来感到缓慢的任务。这些你就可以通过 Redis来进行优化，或者为应用创建些新的功能。在本文中，我就想探讨一些怎样将Redis加入到现有的环境中，并利用它的原语命令等功能来解决 传统环境中碰到的一些常见问题。在这些例子中，Redis都不是作为首选数据库。<br><br>1. 显示最新的项目列表<br><br>下面这个语句常用来显示最新项目，随着数据多了，查询毫无疑问会越来越慢。<br><br><br><br>    SELECT <em> FROM foo WHERE … ORDER BY time DESC LIMIT 10<br><br>———-


</em>在Web应用中，“列出最新的回复”之类的查询非常普遍，这通常会带来可扩展性问题。这令人沮丧，因为项目本来就是按这个顺序被创建的，但要输出这个顺序却不得不进行排序操作。<br><br>类似的问题就可以用Redis来解决。比如说，我们的一个Web应用想要列出用户贴出的最新20条评论。在最新的评论边上我们有一个“显示全部”的链接，点击后就可以获得更多的评论。<br><br>我们假设数据库中的每条评论都有一个唯一的递增的ID字段。<br><br>我们可以使用分页来制作主页和评论页，使用Redis的模板，每次新评论发表时，我们会将它的ID添加到一个Redis列表：<br><br>    LPUSH latest.comments <id><br><br>我们将列表裁剪为指定长度，因此Redis只需要保存最新的5000条评论：<br><br>LTRIM latest.comments 0 5000<br><br>每次我们需要获取最新评论的项目范围时，我们调用一个函数来完成（使用伪代码）：<br><br>    FUNCTION get_latest_comments(start, num_items):<br><br>    id_list = redis.lrange(“latest.comments”,start,start+num_items - 1)<br><br>    IF id_list.length &lt; num_items<br><br>        id_list = SQL_DB(“SELECT … ORDER BY time LIMIT …”)<br><br>    END<br><br>    RETURN id_list<br><br>    END<br><br><br><br>这里我们做的很简单。在Redis中我们的最新ID使用了常驻缓存，这是一直更新的。但是我们做了限制不能超过5000个ID，因此我们的获取ID函数会一直询问Redis。只有在start/count参数超出了这个范围的时候，才需要去访问数据库。<br><br>我们的系统不会像传统方式那样“刷新”缓存，Redis实例中的信息永远是一致的。SQL数据库（或是硬盘上的其他类型数据库）只是在用户需要获取“很远”的数据时才会被触发，而主页或第一个评论页是不会麻烦到硬盘上的数据库了。<br><br>2. 删除与过滤<br><br>我们可以使用LREM来删除评论。如果删除操作非常少，另一个选择是直接跳过评论条目的入口，报告说该评论已经不存在。<br><br>       有些时候你想要给不同的列表附加上不同的过滤器。如果过滤器的数量受到限制，你可以简单的为每个不同的过滤器使用不同的Redis列表。毕竟每个列表只有5000条项目，但Redis却能够使用非常少的内存来处理几百万条项目。<br><br>3. 排行榜相关<br><br>另一个很普遍的需求是各种数据库的数据并非存储在内存中，因此在按得分排序以及实时更新这些几乎每秒钟都需要更新的功能上数据库的性能不够理想。<br><br>典型的比如那些在线游戏的排行榜，比如一个Facebook的游戏，根据得分你通常想要：<br><br>         - 列出前100名高分选手<br><br>         - 列出某用户当前的全球排名<br><br>      这些操作对于Redis来说小菜一碟，即使你有几百万个用户，每分钟都会有几百万个新的得分。<br><br>      模式是这样的，每次获得新得分时，我们用这样的代码：<br><br>      ZADD leaderboard  <score>  <username><br><br>     你可能用userID来取代username，这取决于你是怎么设计的。<br><br>      得到前100名高分用户很简单：ZREVRANGE leaderboard 0 99。<br><br>      用户的全球排名也相似，只需要：ZRANK leaderboard <username>。<br><br><br><br>4、按照用户投票和时间排序<br><br>排行榜的一种常见变体模式就像Reddit或Hacker News用的那样，新闻按照类似下面的公式根据得分来排序：<br><br>       score = points / time^alpha<br><br>因此用户的投票会相应的把新闻挖出来，但时间会按照一定的指数将新闻埋下去。下面是我们的模式，当然算法由你决定。<br><br>模式是这样的，开始时先观察那些可能是最新的项目，例如首页上的1000条新闻都是候选者，因此我们先忽视掉其他的，这实现起来很简单。<br><br>每次新的新闻贴上来后，我们将ID添加到列表中，使用LPUSH + LTRIM，确保只取出最新的1000条项目。<br><br>有一项后台任务获取这个列表，并且持续的计算这1000条新闻中每条新闻的最终得分。计算结果由ZADD命令按照新的顺序填充生成列表，老新闻则被清除。这里的关键思路是排序工作是由后台任务来完成的。<br><br><br><br>5. 处理过期项目<br><br>另一种常用的项目排序是按照时间排序。我们使用unix时间作为得分即可。<br><br>模式如下：<br><br>- 每次有新项目添加到我们的非Redis数据库时，我们把它加入到排序集合中。这时我们用的是时间属性，current_time和time_to_live。<br><br>- 另一项后台任务使用ZRANGE…SCORES查询排序集合，取出最新的10个项目。如果发现unix时间已经过期，则在数据库中删除条目。<br><br><br><br>6. 计数<br><br>Redis是一个很好的计数器，这要感谢INCRBY和其他相似命令。<br><br>我相信你曾许多次想要给数据库加上新的计数器，用来获取统计或显示新信息，但是最后却由于写入敏感而不得不放弃它们。<br><br>好了，现在使用Redis就不需要再担心了。有了原子递增（atomic increment），你可以放心的加上各种计数，用GETSET重置，或者是让它们过期。<br><br>例如这样操作：<br><br>         INCR user:<id> EXPIRE<br><br>         user:<id> 60<br><br>你可以计算出最近用户在页面间停顿不超过60秒的页面浏览量，当计数达到比如20时，就可以显示出某些条幅提示，或是其它你想显示的东西。<br><br>7、特定时间内的特定项目<br><br>另一项对于其他数据库很难，但Redis做起来却轻而易举的事就是统计在某段特点时间里有多少特定用户访问了某个特定资源。比如我想要知道某些特定的注册用户或IP地址，他们到底有多少访问了某篇文章。<em>

</em>每次我获得一次新的页面浏览时我只需要这样做：<br><br>       SADD page:day1:<page_id> <user_id><br><br>      当然你可能想用unix时间替换day1，比如time()-(time()%3600<em>24)等等。<br><br>      想知道特定用户的数量吗？只需要使用SCARD page:day1:<page_id>。<br><br>       需要测试某个特定用户是否访问了这个页面？SISMEMBER page:day1:<page_id>。<br><br><br><br>8. 实时分析正在发生的情况，用于数据统计与防止垃圾邮件等<br><br>我们只做了几个例子，但如果你研究Redis的命令集，并且组合一下，就能获得大量的实时分析方法，有效而且非常省力。使用Redis原语命令，更容易实施垃圾邮件过滤系统或其他实时跟踪系统。<br><br><br><br>9. Pub/Sub<br><br>Redis的Pub/Sub非常非常简单，运行稳定并且快速。支持模式匹配，能够实时订阅与取消频道。<br><br>10. 队列<br><br>你应该已经注意到像list push和list pop这样的Redis命令能够很方便的执行队列操作了，但能做的可不止这些：比如Redis还有list pop的变体命令，能够在列表为空时阻塞队列。<br><br>现代的互联网应用大量地使用了消息队列（Messaging）。消息队列不仅被用于系统内部组件之间的通信，同时也被用于系统跟其它服务之间的交互。消息队 列的使用可以增加系统的可扩展性、灵活性和用户体验。非基于消息队列的系统，其运行速度取决于系统中最慢的组件的速度（注：短板效应）。而基于消息队列可 以将系统中各组件解除耦合，这样系统就不再受最慢组件的束缚，各组件可以异步运行从而得以更快的速度完成各自的工作。<br><br>此外，当服务器处在高并发操作的时候，比如频繁地写入日志文件。可以利用消息队列实现异步处理。从而实现高性能的并发操作。<br><br><br><br>11. 缓存<br><br>Redis的缓存部分值得写一篇新文章，我这里只是简单的说一下。Redis能够替代memcached，让你的缓存从只能存储数据变得能够更新数据，因此你不再需要每次都重新生成数据了。<br><br>此部分内容的原文地址：<a href="http://antirez.com/post/take-advantage-of-redis-adding-it-to-your-stack.html" target="_blank" rel="external">http://antirez.com/post/take-advantage-of-redis-adding-it-to-your-stack.html</a>

</page_id></page_id></em><br><br>## 国内外三个不同领域巨头分享的Redis实战经验及使用场景<br><br><br><br><em>随着应用对高性能需求的增加，NoSQL逐渐在各大名企的系统架构中生根发芽。这里我们将为大家分享社交巨头新浪微博、传媒巨头Viacom及图片分享领域佼佼者Pinterest带来的Redis实践，首先我们看新浪微博 @启盼cobain的Redis实战经验分享：<br><br><strong>一、新浪微博：史上最大的Redis集群</strong><br><br>Tape is Dead，Disk is Tape，Flash is Disk，RAM Locality is King. — Jim Gray<br><br>Redis不是比较成熟的memcache或者Mysql的替代品，是对于大型互联网类应用在架构上很好的补充。现在有越来越多的应用也在纷纷基于Redis做架构的改造。首先简单公布一下Redis平台实际情况：<br><br>2200+亿 commands/day 5000亿Read/day 500亿Write/day<br><br>18TB+ Memory<br><br>500+ Servers in 6 IDC 2000+instances<br><br>应该是国内外比较大的Redis使用平台，今天主要从应用角度谈谈Redis服务平台。<br><br><strong>Redis使用场景*</strong></em><br><br>1. Counting（计数）<br><br>计数的应用在另外一篇文章里较详细的描述，计数场景的优化 <a href="http://www.xdata.me/?p=262这里就不多加描述了。" target="_blank" rel="external">http://www.xdata.me/?p=262这里就不多加描述了。</a><br><br>可以预见的是，有很多同学认为把计数全部存在内存中成本非常高，我在这里用个图表来表达下我的观点：<br><br><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/counting.png" alt=""><br><br>很多情况大家都会设想纯使用内存的方案会很有很高成本，但实际情况往往会有一些不一样：<br><br>COST，对于有一定吞吐需求的应用来说，肯定会单独申请DB、Cache资源，很多担心DB写入性能的同学还会主动将DB更新记入异步队列，而这三块的资源的利用率一般都不会太高。资源算下来，你惊异的发现：反而纯内存的方案会更精简！<br><br>KISS原则，这对于开发是非常友好的，我只需要建立一套连接池，不用担心数据一致性的维护，不用维护异步队列。<br><br>Cache穿透风险，如果后端使用DB，肯定不会提供很高的吞吐能力，cache宕机如果没有妥善处理，那就悲剧了。<br><br>大多数的起始存储需求，容量较小。<br><br>2. Reverse cache（反向cache）<br><br>面对微博常常出现的热点，如最近出现了较为火爆的短链，短时间有数以万计的人点击、跳转，而这里会常常涌现一些需求，比如我们向快速在跳转时判定用户等级，是否有一些账号绑定，性别爱好什么的，已给其展示不同的内容或者信息。<br><br>普通采用memcache+Mysql的解决方案，当调用id合法的情况下，可支撑较大的吞吐。但当调用id不可控，有较多垃圾用户调用时，由于memcache未有命中，会大量的穿透至Mysql服务器，瞬间造成连接数疯长，整体吞吐量降低，响应时间变慢。<br><br>这里我们可以用redis记录全量的用户判定信息，如string key:uid int:type，做一次反向的cache，当用户在redis快速获取自己等级等信息后，再去Mc+Mysql层去获取全量信息。如图：<br><br><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/redis cluster.jpeg" alt=""><br><br>当然这也不是最优化的场景，如用Redis做bloomfilter，可能更加省用内存。<br><br>3. Top 10 list<br><br>产品运营总会让你展示最近、最热、点击率最高、活跃度最高等等条件的top list。很多更新较频繁的列表如果使用MC+MySQL维护的话缓存失效的可能性会比较大，鉴于占用内存较小的情况，使用Redis做存储也是相当不错的。<br><br>4. Last Index<br><br>用户最近访问记录也是redis list的很好应用场景，lpush lpop自动过期老的登陆记录，对于开发来说还是非常友好的。<br><br>5. Relation List/Message Queue<br><br>这里把两个功能放在最后，因为这两个功能在现实问题当中遇到了一些困难，但在一定阶段也确实解决了我们很多的问题，故在这里只做说明。<br><br>Message Queue就是通过list的lpop及lpush接口进行队列的写入和消费，由于本身性能较好也能解决大部分问题。<br><br>6. Fast transaction with Lua<br><br>Redis 的Lua的功能扩展实际给Redis带来了更多的应用场景，你可以编写若干command组合作为一个小型的非阻塞事务或者更新逻辑，如：在收到 message推送时，同时1.给自己的增加一个未读的对话 2.给自己的私信增加一个未读消息 3.最后给发送人回执一个完成推送消息，这一层逻辑完全可以在Redis Server端实现。<br><br>但是，需要注意的是Redis会将lua script的全部内容记录在aof和传送给slave，这也将是对磁盘，网卡一个不小的开销。<br><br>7. Instead of Memcache<br><br>很多测试和应用均已证明，在性能方面Redis并没有落后memcache多少，而单线程的模型给Redis反而带来了很强的扩展性。<br><br>在很多场景下，Redis对同一份数据的内存开销是小于memcache的slab分配的。<br><br>Redis提供的数据同步功能，其实是对cache的一个强有力功能扩展。<br><br><font color="#4590a3" size="4px">Redis使用的重要点</font>  

<ol>
<li>rdb/aof Backup!</li>
</ol>
<p>我们线上的Redis 95%以上是承担后端存储功能的，我们不仅用作cache，而更为一种k-v存储，他完全替代了后端的存储服务（MySQL），故其数据是非常重要的，如 果出现数据污染和丢失，误操作等情况，将是难以恢复的。所以备份是非常必要的！为此，我们有共享的hdfs资源作为我们的备份池，希望能随时可以还原业务 所需数据。</p>
<ol>
<li>Small item &amp; Small instance!</li>
</ol>
<p>由于Redis单线程（严格意义上不是单线程，但认为对request的处理是单线程的）的模型，大的数据结构list,sorted set,hash set的批量处理就意味着其他请求的等待，故使用Redis的复杂数据结构一定要控制其单key-struct的大小。</p>
<p>另外，Redis单实例的内存容量也应该有严格的限制。单实例内存容量较大后，直接带来的问题就是故障恢复或者Rebuild从库的时候时间较长，而更糟 糕的是，Redis rewrite aof和save rdb时，将会带来非常大且长的系统压力，并占用额外内存，很可能导致系统内存不足等严重影响性能的线上故障。我们线上96G/128G内存服务器不建议 单实例容量大于20/30G。</p>
<ol>
<li>Been Available!</li>
</ol>
<p>业界资料和使用比较多的是Redis sentinel（哨兵）</p>
<p><a href="http://www.huangz.me/en/latest/storage/redis_code_analysis/sentinel.html" target="_blank" rel="external">http://www.huangz.me/en/latest/storage/redis_code_analysis/sentinel.html</a></p>
<p><a href="http://qiita.com/wellflat/items/8935016fdee25d4866d9" target="_blank" rel="external">http://qiita.com/wellflat/items/8935016fdee25d4866d9</a></p>
<p>2000行C实现了服务器状态检测，自动故障转移等功能。</p>
<p>但由于自身实际架构往往会复杂，或者考虑的角度比较多，为此 @许琦eryk和我一同做了hypnos项目。</p>
<p>hypnos是神话中的睡神，字面意思也是希望我们工程师无需在休息时间处理任何故障。:-)</p>
<p>其工作原理示意如下：</p>
<p><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/Redis sentinel.png" alt=""></p>
<p>Talk is cheap, show me your code! 稍后将单独写篇博客细致讲下Hypnos的实现。</p>
<ol>
<li>In Memory or not?</li>
</ol>
<p>发现一种情况，开发在沟通后端资源设计的时候，常常因为习惯使用和错误了解产品定位等原因，而忽视了对真实使用用户的评估。也许这是一份历史数据，只有最近一天的数据才有人进行访问，而把历史数据的容量和最近一天请求量都抛给内存类的存储现实是非常不合理的。</p>
<p>所以当你在究竟使用什么样的数据结构存储的时候，请务必先进行成本衡量，有多少数据是需要存储在内存中的？有多少数据是对用户真正有意义的。因为这其实对后端资源的设计是至关重要的，1G的数据容量和1T的数据容量对于设计思路是完全不一样的</p>
<pre><code>Plans in future?
</code></pre><ol>
<li>slave sync改造</li>
</ol>
<p>全部改造线上master-slave数据同步机制，这一点我们借鉴了MySQL Replication的思路，使用rdb+aof+pos作为数据同步的依据，这里简要说明为什么官方提供的psync没有很好的满足我们的需求：</p>
<p>假设A有两个从库B及C，及 A `— B&amp;C，这时我们发现master A服务器有宕机隐患需要重启或者A节点直接宕机，需要切换B为新的主库，如果A、B、C不共享rdb及aof信息，C在作为B的从库时，仍会清除自身数 据，因为C节点只记录了和A节点的同步状况。</p>
<p>故我们需要有一种将A<code>–B&amp;C 结构切换切换为A</code>–B`–C结构的同步机制，psync虽然支持断点续传，但仍无法支持master故障的平滑切换。</p>
<p>实际上我们已经在我们定制的Redis计数服务上使用了如上功能的同步，效果非常好，解决了运维负担，但仍需向所有Redis服务推广，如果可能我们也会向官方Redis提出相关sync slave的改进。</p>
<p>2.更适合redis的name-system Or proxy</p>
<p>细心的同学发现我们除了使用DNS作为命名系统，也在zookeeper中有一份记录，为什么不让用户直接访问一个系统，zk或者DNS选择其一呢？</p>
<p>其实还是很简单，命名系统是个非常重要的组件，而dns是一套比较完善的命名系统，我们为此做了很多改进和试错，zk的实现还是相对复杂，我们还没有较强的把控粒度。我们也在思考用什么做命名系统更符合我们需求。</p>
<p>3.后端数据存储</p>
<p>大内存的使用肯定是一个重要的成本优化方向，flash盘及分布式的存储也在我们未来计划之中。（原文链接： Largest Redis Clusters Ever）</p>
<p><strong>二、Pinterest：Reids维护上百亿的相关性</strong></p>
<p>Pinterest已经成为硅谷最疯故事之一，在2012年，他们基于PC的业务增加1047%，移动端采用增加1698%， 该年3月其独立访问数量更飙升至533亿。在Pinterest，人们关注的事物以百亿记——每个用户界面都会查询某个board或者是用户是否关注的行为促成了异常复杂的工程问题。这也让Redis获得了用武之地。经过数年的发展，Pinterest已经成为媒体、社交等多个领域的佼佼者，其辉煌战绩如下：</p>
<p>获得的推荐流量高于Google+、YouTube及LinkedIn三者的总和</p>
<p>与Facebook及Twitter一起成为最流行的三大社交网络</p>
<p>参考Pinterest进行购买的用户比其它网站更高（ 更多详情）</p>
<p>如您所想，基于其独立访问数，Pinterest的高规模促成了一个非常高的IT基础设施需求。</p>
<p><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/Pinterest.jpg" alt=""> </p>
<p>通过缓存来优化用户体验</p>
<p>近日，Pinterest工程经理Abhi Khune对其公司的用户体验需求及Redis的使用经验 进行了分享。即使是滋生的应用程序打造者，在分析网站的细节之前也不会理解这些特性，因此先大致的理解一下使用场景：首先，为每个粉丝进行提及到的预检查；其次，UI将准确的显示用户的粉丝及关注列表分页。高效的执行这些操作，每次点击都需要非常高的性能架构。</p>
<p>不能免俗，Pinterest的软件工程师及架构师已经使用了MySQL及memcache，但是缓存解决方案仍然达到了他们的瓶颈；因此为了拥有更好的 用户体验，缓存必须被扩充。而在实际操作过程中，工程团队已然发现缓存只有当用户sub-graph已经在缓存中时才会起到作用。因此。任何使用这个系统 的人都需要被缓存，这就导致了整个图的缓存。同时，最常见的查询“用户A是否关注了用户B”的答案经常是否定的，然而这却被作为了缓存丢失，从而促成一个 数据库查询，因此他们需要一个新的方法来扩展缓存。最终，他们团队决定使用Redis来存储整个图，用以服务众多的列表。</p>
<p>使用Redis存储大量的Pinterest列表</p>
<p>Pinterest使用了Redis作为解决方案，并将性能推至了内存数据库等级，为用户保存多种类型列表：</p>
<p>关注者列表</p>
<p>你所关注的board列表</p>
<p>粉丝列表</p>
<p>关注你board的用户列表</p>
<p>某个用户中board中你没有关注的列表</p>
<p>每个board的关注者及非关注者</p>
<p>Redis为其7000万用户存储了以上的所有列表，本质上讲可以说是储存了所有粉丝图，通过用户ID分片。鉴于你可以通过类型来查看以上列表的数据，分 析概要信息被用看起来更像事务的系统储存及访问。Pinterest当下的用户like被限制为10万，初略进行统计：如果每个用户关注25个 board，将会在用户及board间产生17.5亿的关系。同时更加重要的是，这些关系随着系统的使用每天都会增加。</p>
<p>Pinterest的Reids架构及运营</p>
<p>通过Pinterest的一个创始人了解到，Pinterest开始使用Python及订制的Django编写应用程序，并一直持续到其拥有1800万用 户级日410TB用户数据的时候。虽然使用了多个存储对数据进行储存，工程师根据用户id使用了8192个虚拟分片，每个分片都运行在一个 Redis DB之上，同时1个Redis实例将运行多个Redis DB。为了对CPU核心的充分使用，同一台主机上同时使用多线程和单线程Redis 实例。</p>
<p>鉴于整个数据集运行在内存当中，Redis在Amazon EBS上对每秒传输进来的写入都会进行持久化。扩展主要通过两个方面进行：第一，保持50%的 利用率，通过主从转换，机器上运行的Redis实例一半会转译到一个新机器上；第二，扩展节点和分片。整个Redis集群都会使用一个主从配置，从部分将 被当做一个热备份。一旦主节点失败，从部分会立刻完成主的转换，同时一个新的从部分将会被添加，ZooKeeper将完成整个过程。同时他们每个小时都会 在Amazon S3上运行BGsave做更持久的储存——这项Reids操作会在后端进行，之后Pinterest会使用这些数据做MapReduce 和分析作业。（更多内容见原文）</p>
<p><img src="http://wowchris.github.io/2017/02/21/Redis-应用场景/vlacom.jpg" alt=""></p>
<p><strong>三、Viacom：Redis在系统中的用例盘点</strong></p>
<p>Viacom是全球最大的传媒集体之一，同时也遭遇了当下最大的数据难题之一：如何处理日益剧增的动态视频内容。</p>
<p>着眼这一挑战的上升趋势，我们会发现：2010年世界上所有数据体积达到ZB级，而单单2012这一年，互联网产生的数据就增加了2.8个ZB，其中大部分的数据都是非结构化的，包括了视频和图片。</p>
<p>覆盖MVN（以前称为MTV Networks、Paramount及BET），Viacom是个名副其实的传媒巨头，支持众多人气站点，其中包括 The Daily Show、osh.0、South Park Studios、GameTrailers.com等。作为媒体公司，这些网站上的文 档、图片、视频短片都在无时无刻的更新。长话短说，下面就进入Viacom高级架构师Michael Venezia 分享的Redis实践：</p>
<p>Viacom的网站架构背景</p>
<p>对于Viacom，横跨多个站点传播内容让必须专注于规模的需求，同时为了将内容竟可能快的传播到相应用户，他们还必须聚焦内容之间的关系。然而即使 The Daily Show、Nickelodeon、Spike或者是VH1 这些单独的网站上，日平均PV都可以达到千万，峰值时流量更会达到平均 值的20-30倍。同时基于对实时的需求，动态的规模及速度已成为架构的基础之一。</p>
<p>除去动态规模之外，服务还必须基于用户正在浏览的视频或者是地理位置来推测用户的喜好。比如说，某个页面可能会将一个独立的视频片段与本地的促销，视频系 列的额外部分，甚至是相关视频联系起来。为了能让用户能在网站上停留更长的时间，他们建立了一个能基于详细元数据自动建立页面的软件引擎，这个引擎可以根 据用户当下兴趣推荐额外的内容。鉴于用于兴趣的随时改变，数据的类型非常广泛——类似graph-like，实际上做的是大量的join。</p>
<p>这样做有利于减少类似视频的大体积文件副本数，比如数据存储中一个独立的记录是Southpark片段 “Cartman gets an Anal Probe”，这个片段可能也会出现在德语的网站上。虽然视频是一样的，但是英语用户搜索的可能就是另一个 不同的词语。元数据的副本转换成搜索结果，并指向相同的视频。因此在美国用户搜索真实标题的情况下，德国浏览者可能会使用转译的标题——德国网站上的 “Cartman und die Analsonde”。</p>
<p>这些元数据覆盖了其它记录或者是对象，同时还可以根据使用环境来改变内容，通过不同的规则集来限制不同地理位置或者是设备请求的内容。</p>
<p>Viacom的实现方法</p>
<p>尽管许多机构通过使用ORM及传统关系型数据库来解决这个问题，Viacom却使用了一个迥然不同的方法。</p>
<p>本质上，他们完全承担不了对数据库的直接访问。首先，他们处理的大部分都是流数据，他们偏向于使用Akamai从地理上来分配内容。其次，基于页面的复杂 性可能会取上万个对象。取如此多的数据显然会影响到性能，因此JSON在1个数据服务中投入了使用。当然，这些JSON对象的缓存将直接影响到网站性能。 同时，当内容或者是内容之间的关系发生改变时，缓存还需要动态的进行更新。</p>
<p>Viacom依靠对象基元和超类解决这个问题，继续以South Park为例：一个私有的“episode”类包含了所有该片段相关信息，一个 “super object”将有助于发现实际的视频对象。超类这个思想确实非常有益于建设低延迟页面的自动建设，这些超类可以帮助到基元对象到缓存的映 射及保存。</p>
<p>Viacom为什么要使用Redis</p>
<p>每当Viacom上传一个视频片段，系统将建立一个私有的对象，并于1个超类关联。每一次修改，他们都需要重估私有对象的每个改变，并更新所有复合对象。 同时，系统还需要无效Akamail中的URL请求。系统现有架构的组合及更敏捷的管理方法需求将Viacom推向了Redis。</p>
<p>基于Viacom主要基于PHP，所以这个解决方案必须支持PHP。他们首先选择了memcached做对象存储，但是它并不能很好的支持 hashmap；同时他们还需要一个更有效的进行无效步骤的重估，即更好的理解内容的依赖性。本质上说，他们需要时刻跟进无效步骤中的依赖性改变。因此他 们选择了Redis及Predis的组合来解决这个问题。</p>
<p>他们团队使用Redis给southparkstudios.com和thedailyshow.com两个网站建设依赖性图，在取得了很大的成功后他们开始着眼Redis其它适合场景。</p>
<p>Redis的其它使用场景</p>
<p>显而易见，如果有人使用Redis来建设依赖性图，那么使用它来做对象处理也是说得通的。同样，这也成了架构团队为Redis选择的第二使用场景。 Redis的复制及持久化特性同时也征服了Viacom的运营团队，因此在几个开发周期后，Redis成为他们网站的主要数据及依赖性储存。</p>
<p>后两个用例则是行为追踪及浏览计数的缓冲，改变后的架构是Redis每几分钟向MySQL中储存一次，而浏览计数则通过Redis进行存储及计数。同时 Redis还被用来做人气的计算，一个基于访问数及访问时间的得分系统——如果某个视频最近被访问的次数越多，它的人气就越高。在如此多内容上每隔 10-15分钟做一次计算绝对不是类似MySQL这样传统关系型数据库的强项，Viacom使用Redis的理由也非常简单——在1个存储浏览信息的 Redis实例上运行Lua批处理作业，计算出所有的得分表。信息被拷贝到另一个Redis实例上，用以支持相关的产品查询。同时还在MySQL上做了另 一个备份，用以以后的分析，这种组合会将这个过程耗费的时间降低60倍。</p>
<p>Viacom还使用Redis存储一步作业信息，这些信息被插入一个列表中，工作人员则使用BLPOP命令行在队列中抓取顶端的任务。同时zsets被用于从众多社交网络（比如Twitter及Tumblr）上综合内容，Viacom通过Brightcove视频播放器来同步多个内容管理系统。</p>
<p>横跨这些用例，几乎所有的Redis命令都被使用——sets、lists、zlists、hashmaps、scripts、counters等。同时，Redis也成为Viacom可扩展架构中不可或缺的一环。<br>*</p>
<p>hello <a href="http://www.jjl1979.com/2017/02/21/Redis-应用场景/">http://www.jjl1979.com/2017/02/21/Redis-应用场景/</a> bye</p>
</user_id></page_id></id></id></username></username></score></id>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/02/21/Redis-和-Memcache-的区别/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/21/Redis-和-Memcache-的区别/" itemprop="url">
                  Redis 和 Memcache 的区别
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-21T11:21:24+08:00">
                2017-02-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/memcache/" itemprop="url" rel="index">
                    <span itemprop="name">memcache</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="总结一："><a href="#总结一：" class="headerlink" title="总结一："></a>总结一：</h2><p>memcache官方定义<br>Free &amp; open source, high-performance, distributed memory object caching system, generic in nature, but intended for use in speeding up dynamic web applications by alleviating database load.<br>redis官方定义<br>Redis is an open source, BSD licensed, advanced key-value store. It is often referred to as a data structure server since keys can contain strings, hashes, lists, sets and sorted sets.<br><strong>版权相同</strong><br>它们都是使用的bsd协议，使用它的项目可以用于商业用户，不必发布二次修改的代码，可以修改源代码。<br><strong>数据类型</strong><br>redis数据类型丰富，支持set liset等类型<br>memcache支持简单数据类型，需要客户端自己处理复杂对象<br><strong>存储方式-持久性</strong><br>redis支持数据落地持久化存储，运行的时候可以将数据备份在磁盘中，断电或重启后，缓存数据可以再次加载到内存中，只要Redis配置的合理，基本上不会丢失数据<br>memcache不支持数据持久存储<br><strong>分布式存储</strong><br>redis支持master-slave复制模式Redis在很多方面具备数据库的特征，或者说就是一个数据库系统<br>memcache可以使用一致性hash做分布式，是简单的K/V缓存<br><strong>value大小不同</strong><br>memcache是一个内存缓存，key的长度小于250字符，单个item存储要小于1M，不适合虚拟机使用，Redis单个value的最大限制是1GB<br><strong>数据一致性不同 </strong><br>redis使用的是单线程模型，保证了数据按顺序提交。<br>memcache需要使用cas保证数据一致性。CAS（Check and Set）是一个确保并发一致性的机制，属于“乐观锁”范畴；原理很简单：拿版本号，操作，对比版本号，如果一致就操作，不一致就放弃任何操作<br><strong>cpu利用</strong><br>redis单线程模型只能使用一个cpu，可以开启多个redis进程</p>
<h2 id="总结二："><a href="#总结二：" class="headerlink" title="总结二："></a>总结二：</h2><ol>
<li>Redis中，并不是所有的数据都一直存储在内存中的，这是和Memcached相比一个最大的区别。</li>
<li>Redis不仅仅支持简单的k/v类型的数据，同时还提供list，set，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份。</li>
<li>Redis支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用.<br>我个人认为最本质的不同是Redis在很多方面具备数据库的特征，或者说就是一个数据库系统，而Memcached只是简单的K/V缓存  </li>
</ol>
<h2 id="总结三："><a href="#总结三：" class="headerlink" title="总结三："></a>总结三：</h2><p>redis和memecache的不同在于：</p>
<ol>
<li>存储方式：<br>memecache 把数据全部存在内存之中，断电后会挂掉，数据不能超过内存大小<br>redis有部份存在硬盘上，这样能保证数据的持久性。</li>
<li>数据支持类型：<br>redis在数据支持上要比memecache多的多。</li>
<li>使用底层模型不同：<br>新版本的redis直接自己构建了VM 机制 ，因为一般的系统调用系统函数的话，会浪费一定的时间去移动和请求。<br>Memcached的内存管理不像Redis那么复杂，元数据metadata更小，相对来说额外开销就很少。Memcached唯一支持的数据类型是字符串string，非常适合缓存<strong>只读</strong>数据，因为字符串不需要额外的处理 </li>
</ol>
<p>redis的内容是可以落地的，就是说跟mongodb有些类似，然后redis也可以作为缓存，并且可以设置master-slave</p>
<p>hello <a href="http://www.jjl1979.com/2017/02/21/Redis-和-Memcache-的区别/">http://www.jjl1979.com/2017/02/21/Redis-和-Memcache-的区别/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/02/15/nginx编译常用参数及参数介绍/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/nginx编译常用参数及参数介绍/" itemprop="url">
                  nginx编译常用参数及参数介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-15T19:27:20+08:00">
                2017-02-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>nginx编译常用参数及参数介绍  </p>
<h2 id="我用的"><a href="#我用的" class="headerlink" title="我用的"></a>我用的</h2><pre><code>yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre pcre-devel
</code></pre><blockquote>
<p>./configure  –prefix=/usr/local/nginx –sbin-path=/usr/sbin/nginx –conf-path=/etc/nginx/nginx.conf  –add-module=/usr/local/src/nginx-sticky-module –with-http_stub_status_module –with-http_ssl_module –add-module=/usr/local/src/ngx_devel_kit-0.3.0/ –add-module=/usr/local/src/lua-nginx-module-0.10.6rc1/ –error-log-path=/opt/nginx/logs/error.log –http-log-path=/opt/nginx/logs/access.log  –pid-path=/var/run/nginx/nginx.pid   –with-http_ssl_module –with-http_flv_module –with-http_stub_status_module –with-http_gzip_static_module  –lock-path=/var/lock/nginx.lock  –http-client-body-temp-path=/var/tmp/nginx/client/  –http-proxy-temp-path=/var/tmp/nginx/proxy/    –http-fastcgi-temp-path=/var/tmp/nginx/fcgi/  –http-uwsgi-temp-path=/var/tmp/nginx/uwsgi  –http-scgi-temp-path=/var/tmp/nginx/scgi  </p>
</blockquote>
<h2 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">$ ./configure \                    #nginx启动</div><div class="line">--prefix=/usr/local/nginx \             # 设定安装目录,默认使用 /usr/local/nginx。</div><div class="line">--sbin-path=/usr/local/nginx/nginx \    # 设置nginx的可执行文件的路径，默认为prefix/sbin/nginx.</div><div class="line">--conf-path=/etc/nginx/nginx.conf \     # 设置在nginx.conf配置文件的路径。nginx允许使用不同的配置文件启动，通过命令行中的-c选项。默认为prefix/conf/nginx.conf.</div><div class="line">--error-log-path=/var/log/nginx/error.log \     # 设置主错误，警告，和诊断文件的名称。安装完成后，可以随时改变的文件名 ，在nginx.conf配置文件中 使用 的error_log指令。默认情况下，文件名 为prefix/logs/error.log.</div><div class="line">--http-log-path=/var/log/nginx/access.log \     # 设置主请求的HTTP服务器的日志文件的名称。安装完成后，可以随时改变的文件名 ，在nginx.conf配置文件中 使用 的access_log指令。默认情况下，文件名 为prefix/logs/access.log.</div><div class="line">--pid-path=/var/run/nginx.pid \         # 设置nginx.pid文件，将存储的主进程的进程号。安装完成后，可以随时改变的文件名 ， 在nginx.conf配置文件中使用 PID指令。默认情况下，文件名 为prefix/logs/nginx.pid.</div><div class="line">--lock-path=/var/run/nginx.lock \       # 设定lock文件(nginx.lock)目录</div><div class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp \ # 设置客户端请求临时文件路径</div><div class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp \        # 设置http proxy临时文件路径</div><div class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \    # 设置http fastcgi临时文件路径</div><div class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \        # 设置路径存储http uwsgi临时文件路径</div><div class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \          # 设置路径存储http scgi临时文件路径</div><div class="line">--user=nginx \      #  设置nginx工作进程的用户。安装完成后，可以随时更改的名称在nginx.conf配置文件中 使用的 user指令。默认的用户名是nobody。</div><div class="line">--group=nginx \     # 设置nginx工作进程的用户组。安装完成后，可以随时更改的名称在nginx.conf配置文件中 使用的 user指令。默认的为非特权用户。</div><div class="line">--with-http_ssl_module \        # 使用https协议模块。默认情况下，该模块没有被构建。建立并运行此模块的OpenSSL库是必需的。</div><div class="line">--with-http_realip_module \     # 允许ngx_http_realip_module模块(mod_rpaf)</div><div class="line">--with-http_addition_module \   # ..模块(mod_layout)</div><div class="line">--with-http_sub_module \        # ..模块（允许用一些其他文本替换nginx响应中的一些文本）</div><div class="line">--with-http_dav_module \        # ..模块(mod_dav)（增加PUT,DELETE,MKCOL：创建集合,COPY和MOVE方法）默认情况下为关闭，需编译开启  </div><div class="line">--with-http_flv_module \        # ..(mod_flvx)</div><div class="line">--with-http_mp4_module \        # ..模块(mod_mp4)</div><div class="line">--with-http_gunzip_module \     # ..模块(mod_gunzip)</div><div class="line">--with-http_gzip_static_module \        # ..模块(mod_dflate)</div><div class="line">--with-http_random_index_module \       # ..模块(mod_autoindex)</div><div class="line">--with-http_secure_link_module \        # ..模块</div><div class="line">--with-http_stub_status_module \        # ..模块(mod_status)通过web界面查看时Nginx需要开启status模块</div><div class="line">--with-http_auth_request_module \       # 允许ngx_http_auth_request_module模块</div><div class="line">--with-http_xslt_module         # 允许ngx_http_xslt_module模块</div><div class="line">--with-mail \       # 允许POP3/IMAP4/SMTP代理模块</div><div class="line">--with-mail_ssl_module \        # 允许ngx_mail_ssl_module模块</div><div class="line">--with-file-aio \   # 允许文件AIO支持</div><div class="line">--with-ipv6 \       # 允许IP6代理支持</div><div class="line">--with-http_spdy_module \   # 允许ngx_http_spdy_module模块1.9.5开始要把把--with-http_spdy_module换成--with-http_v2_module，不然报错</div><div class="line">--with-cc-opt=&apos;-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic&apos;  # 设置C编译器参数</div><div class="line">--without-http_charset_module       # 不使用ngx_http_charset_module模块</div><div class="line">--without-http_gzip_module          # 不使用ngx_..模块</div><div class="line">--without-http_ssi_module           # 不使用ngx_..模块</div><div class="line">--without-http_userid_module        # 不使用ngx_..模块</div><div class="line">--without-http_access_module        # 不使用ngx_..模块</div><div class="line">--without-http_auth_basic_module    # 不使用ngx_..模块</div><div class="line">--without-http_autoindex_module     # 不使用ngx_..模块  </div><div class="line">--without-http_geo_module           # 不使用ngx_..模块  </div><div class="line">--without-http_map_module           # 不使用ngx_..模块</div><div class="line">--without-http_referer_module       # 不使用ngx_..模块</div><div class="line">--without-http_rewrite_module       # 不使用ngx_..模块</div><div class="line">--without-http_proxy_module         # 不使用ngx_..模块</div><div class="line">--without-http_fastcgi_module       # 不使用ngx_..模块</div><div class="line">--without-http_memcached_module     # 不使用ngx_..模块</div><div class="line">--without-http_limit_zone_module    # 不使用ngx_..模块</div><div class="line">--without-http_empty_gif_module     # 不使用ngx_..模块</div><div class="line">--without-http_browser_module       # 不使用ngx_..模块</div><div class="line">--without-http_upstream_ip_hash_module      # 不使用ngx_..模块</div><div class="line">--with-http_perl_module         # 允许ngx_..模块</div><div class="line">--with-perl_modules_path=PATH   # 设置perl模块路径</div><div class="line">--with-perl=PATH        # 设置perl库文件路径</div><div class="line">--http-log-path=PATH    # 设置access log文件路径</div><div class="line">--without-http          # 不使用HTTP server功能</div><div class="line">--without-mail_pop3_module      # 不允许ngx_..模块</div><div class="line">--without-mail_imap_module      # 不允许ngx_..模块</div><div class="line">--without-mail_smtp_module      # 不允许ngx_..模块</div><div class="line">--with-google_perftools_module      # 允许ngx_..模块(调试用)</div><div class="line">--with-cpp_test_module  # 允许ngx_..模块</div><div class="line">--add-module=PATH       # 允许使用外部模块,以及路径</div><div class="line">--with-cc=PATH          # 设置C编译器路径</div><div class="line">--with-cpp=PATH         # 设置C预处理路径</div><div class="line">--with-ld-opt=OPTIONS   # 设置连接文件参数</div><div class="line">--with-cpu-opt=CPU      # 为指定CPU优化,可选参数有:</div><div class="line">		  pentium, pentiumpro, pentium3, pentium4,</div><div class="line">		  athlon, opteron, sparc32, sparc64, ppc64</div><div class="line">--without-pcre          # 不使用pcre库文件</div><div class="line">--with-pcre=DIR         # 设定PCRE库路径</div><div class="line">--with-pcre-opt=OPTIONS # 设置PCRE运行参数</div><div class="line">--with-md5=DIR          # 设定md5库文件路径</div><div class="line">--with-md5-opt=OPTIONS  # 设置md5运行参数</div><div class="line">--with-md5-asm          # 使用md5源文件编译</div><div class="line">--with-sha1=DIR         # 设定sha1库文件路径</div><div class="line">--with-sha1-opt=OPTIONS # 设置sha1运行参数</div><div class="line">--with-sha1-asm         # 使用sha1源文件编译</div><div class="line">--with-zlib=DIR         # 设定zlib库文件路径</div><div class="line">--with-zlib-opt=OPTIONS # 设置zlib运行参数</div><div class="line">--with-zlib-asm=CPU     # 使zlib对特定的CPU进行优化,可选参数:</div><div class="line">		  pentium, pentiumpro</div><div class="line">--with-openssl=DIR      # 设定OpenSSL库文件路径</div><div class="line">--with-openssl-opt=OPTIONS  # 设置OpenSSL运行参数</div><div class="line">--with-debug            # 允许调试日志</div><div class="line">--builddir=DIR          # 设定程序编译目录</div><div class="line">--with-rtsig_module     # 允许rtsig模块</div><div class="line">--with-select_module    # 允许select模块(一种轮询模式,不推荐用在高载环境)</div><div class="line">--without-select_module # 不使用select模块</div><div class="line">--with-poll_module      # 允许poll模块(一种轮询模式,不推荐用在高载环境)</div><div class="line">--without-poll_module   # 不使用poll模块</div></pre></td></tr></table></figure>
<h2 id="yum-nginx1-10版本默认参数"><a href="#yum-nginx1-10版本默认参数" class="headerlink" title="yum nginx1.10版本默认参数"></a>yum nginx1.10版本默认参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">--prefix=/usr/share/nginx \</div><div class="line">--sbin-path=/usr/sbin/nginx \</div><div class="line">--modules-path=/usr/lib64/nginx/modules \  </div><div class="line">--conf-path=/etc/nginx/nginx.conf \</div><div class="line">--error-log-path=/var/log/nginx/error.log \</div><div class="line">--http-log-path=/var/log/nginx/access.log \</div><div class="line">--http-client-body-temp-path=/var/lib/nginx/tmp/client_body \ </div><div class="line">--http-proxy-temp-path=/var/lib/nginx/tmp/proxy \</div><div class="line">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi \</div><div class="line">--http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi \</div><div class="line">--http-scgi-temp-path=/var/lib/nginx/tmp/scgi \</div><div class="line">--pid-path=/var/run/nginx.pid \</div><div class="line">--lock-path=/var/lock/subsys/nginx \</div><div class="line">--user=nginx \</div><div class="line">--group=nginx \</div><div class="line">--with-file-aio \</div><div class="line">--with-ipv6 \</div><div class="line">--with-http_ssl_module \</div><div class="line">--with-http_v2_module \</div><div class="line">--with-http_realip_module \</div><div class="line">--with-http_addition_module \</div><div class="line">--with-http_xslt_module=dynamic \</div><div class="line">--with-http_image_filter_module=dynamic \</div><div class="line">--with-http_geoip_module=dynamic \</div><div class="line">--with-http_sub_module \</div><div class="line">--with-http_dav_module \</div><div class="line">--with-http_flv_module \</div><div class="line">--with-http_mp4_module \</div><div class="line">--with-http_gunzip_module \</div><div class="line">--with-http_gzip_static_module \</div><div class="line">--with-http_random_index_module \</div><div class="line">--with-http_secure_link_module \</div><div class="line">--with-http_degradation_module \</div><div class="line">--with-http_slice_module \</div><div class="line">--with-http_stub_status_module \</div><div class="line">--with-http_perl_module=dynamic \</div><div class="line">--with-mail=dynamic \</div><div class="line">--with-mail_ssl_module \</div><div class="line">--with-pcre \</div><div class="line">--with-pcre-jit \</div><div class="line">--with-stream=dynamic \</div><div class="line">--with-stream_ssl_module \</div><div class="line">--with-debug \</div><div class="line">--with-cc-opt=&apos;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector \</div><div class="line">--param=ssp-buffer-size=4 -m64 -mtune=generic&apos; \</div><div class="line">--with-ld-opt=&apos; -Wl,-E&apos;</div></pre></td></tr></table></figure>
<p>hello <a href="http://www.jjl1979.com/2017/02/15/nginx编译常用参数及参数介绍/">http://www.jjl1979.com/2017/02/15/nginx编译常用参数及参数介绍/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/02/14/nginx第三方模块-nginx-sticky-module-基于cookie的会话保持/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/14/nginx第三方模块-nginx-sticky-module-基于cookie的会话保持/" itemprop="url">
                  nginx第三方模块---nginx-sticky-module(基于cookie的会话保持)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-14T17:50:09+08:00">
                2017-02-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Cookie和Session"><a href="#Cookie和Session" class="headerlink" title="Cookie和Session"></a>Cookie和Session</h2><ul>
<li>Cookie<br>存在于客户端，是服务端发送给客户端的以明文形式存在的、用来记录一些信息（如用户名），定制主页，访问行为、习惯，最终存储在客户端的数据，可理解为是在客户端保持状态的一种机制。</li>
<li>Session<br>我偏向他是一种应用在服务器端的手段，通过http请求服务器端得到存在于Cookie中的session_id进行session处理，如果没有则创建新id。  </li>
</ul>
<p>http通讯样例<br><img src="http://wowchris.github.io/2017/02/14/nginx第三方模块-nginx-sticky-module-基于cookie的会话保持/http通讯样例.png" alt=""> </p>
<h2 id="模块编译"><a href="#模块编译" class="headerlink" title="模块编译"></a>模块编译</h2><p>下载地址：<a href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/downloads" target="_blank" rel="external">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/downloads</a></p>
<p>hello <a href="http://www.jjl1979.com/2017/02/14/nginx第三方模块-nginx-sticky-module-基于cookie的会话保持/">http://www.jjl1979.com/2017/02/14/nginx第三方模块-nginx-sticky-module-基于cookie的会话保持/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.jjl1979.com/2017/02/13/基于haproxy的mysql主从负载均衡应用/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="红曳">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="红曳的Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="红曳的Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/13/基于haproxy的mysql主从负载均衡应用/" itemprop="url">
                  基于haproxy的mysql主从负载均衡应用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-13T17:59:35+08:00">
                2017-02-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/haproxy/" itemprop="url" rel="index">
                    <span itemprop="name">haproxy</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>服务图例  </p>
<p><img src="http://wowchris.github.io/2017/02/13/基于haproxy的mysql主从负载均衡应用/haproxy的mysql主从负载均衡.png" alt="">   </p>
<p>一、服务器规划<br>192.168.116.132 (master)  –&gt;写操作<br>192.168.116.129 (slave1)  –&gt;读操作<br>192.168.116.131 (slave2)  –&gt;读操作<br>192.168.116.130 (haproxy) –&gt;代理  </p>
<p>二、安装配置haproxy<br>安装haproxy</p>
<ol>
<li>tar zxf haproxy-1.4.21.tar.gz  </li>
<li>cd haproxy-1.4.21  </li>
<li>make TARGET=linux26 PREFIX=/app/haproxy  </li>
<li>make install PREFIX=/app/haproxy  </li>
<li>mkdir /app/haproxy/{conf,log}  </li>
</ol>
<p>配置haproxy<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">vi /app/haproxy/conf/haproxy.cfg <span class="comment">#添加如下内容</span></div><div class="line">global</div><div class="line">        <span class="built_in">log</span> 127.0.0.1   <span class="built_in">local</span>3 info    <span class="comment">#日志相关</span></div><div class="line">        <span class="built_in">log</span> 127.0.0.1   <span class="built_in">local</span>3 notice</div><div class="line">        maxconn 10240</div><div class="line">        chroot /app/haproxy</div><div class="line">        uid root</div><div class="line">        gid root</div><div class="line">        daemon</div><div class="line">        pidfile /app/haproxy/<span class="built_in">log</span>/haproxy.pid</div><div class="line"> </div><div class="line">defaults</div><div class="line">        <span class="comment">#log     global</span></div><div class="line">        mode    http</div><div class="line">        <span class="comment">#option httplog</span></div><div class="line">        <span class="comment">#option  dontlognull</span></div><div class="line">        option  redispatch</div><div class="line">        retries 3</div><div class="line">        option redispatch</div><div class="line">        maxconn         4096</div><div class="line">        contimeout      50000</div><div class="line">        clitimeout      50000</div><div class="line">        srvtimeout      50000</div><div class="line"> </div><div class="line">listen  mysql-proxy</div><div class="line">        <span class="built_in">bind</span> 0.0.0.0:33307    <span class="comment">#代理端口</span></div><div class="line">        mode tcp              <span class="comment">#模式 TCP</span></div><div class="line">        option mysql-check user haproxy   <span class="comment">#mysql健康检查，haproxy用户无任何权限，并且无密码</span></div><div class="line">        balance roundrobin            <span class="comment">#调度算法</span></div><div class="line">        server mysql1-129 192.168.116.129:3306 weight 1 check  inter 1s rise 2 fall 2 <span class="comment">#健康检查加上check</span></div><div class="line">        server mysql2-131 192.168.116.131:3306 weight 1 check  inter 1s rise 2 fall 2</div><div class="line">listen stats     <span class="comment">#监控</span></div><div class="line">           mode http</div><div class="line">           <span class="built_in">bind</span> 0.0.0.0:19999</div><div class="line">           stats <span class="built_in">enable</span></div><div class="line">           stats uri /dbs</div><div class="line">           stats realm Global\ statistics</div><div class="line">           stats auth admin:admin</div></pre></td></tr></table></figure></p>
<p>启动haproxy  </p>
<p>/app/haproxy/sbin/haproxy -f /app/haproxy/conf/haproxy.cfg  </p>
<p>打开浏览器查看：<br><a href="http://192.168.116.130:19999/dbs" target="_blank" rel="external">http://192.168.116.130:19999/dbs</a><br>用户名及密码：admin/admin  </p>
<p><img src="http://wowchris.github.io/2017/02/13/基于haproxy的mysql主从负载均衡应用/haproxy的mysql主从负载均衡-http.png" alt="">   </p>
<p>原文：<a href="http://www.cnblogs.com/Eivll0m/p/4886118.html#3572567" target="_blank" rel="external">http://www.cnblogs.com/Eivll0m/p/4886118.html#3572567</a></p>
<p>hello <a href="http://www.jjl1979.com/2017/02/13/基于haproxy的mysql主从负载均衡应用/">http://www.jjl1979.com/2017/02/13/基于haproxy的mysql主从负载均衡应用/</a> bye</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="红曳" />
          <p class="site-author-name" itemprop="name">红曳</p>
          <p class="site-description motion-element" itemprop="description">Knowledge is power</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">红曳</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>



        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
